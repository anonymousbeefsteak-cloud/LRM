<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Âè∞ÁÅ£Â∞èÂêÉÂ∫ó - LINE Âø´ÈÄüË®ÇÈ§ê</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            background-color: #f7fafc; /* Tailwind gray-100 */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.5s ease-out; }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body oncontextmenu="return false;">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useEffect, useMemo } = React;

        // --- From constants.ts ---
        const LIFF_ID = '2008316489-6nMjb0KX';
        const OBFUSCATED_API_ENDPOINT = 'aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYWNyb3Mvcy9BS2Z5Y2J6ZF9jVnRlWFoxQ2xpdGV6bXhPRDRkSzNCWHBjOTl1ZXJGc29aWThyb0FRZE9NY1c2YktlT1hOMEgyZWswODc2eFEvZXhlYw==';
        const API_ENDPOINT = atob(OBFUSCATED_API_ENDPOINT);
        const OBFUSCATED_API_KEY = 'Z2VuLWxhbmctY2xpZW50LTA4MDAzMzE4Mzk=';
        const API_KEY = atob(OBFUSCATED_API_KEY);
        const DELIVERY_FEE = 30;

        // MENU_ITEMS is now fetched dynamically

        // --- From services/apiService.ts ---
        const getMenu = async () => {
            const payload = { 
                action: 'getMenu', 
                apiKey: API_KEY,
            };
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
            });
            if (!response.ok) throw new Error(`ÁÑ°Ê≥ïËºâÂÖ•ËèúÂñÆ: ${response.status} ${response.statusText}`);
            const result = await response.json();
            if (!result.success || !Array.isArray(result.data)) {
                throw new Error(result.message || 'ËèúÂñÆÊ†ºÂºèÈåØË™§ÔºåË´ãËÅØÁπ´Â∫óÂÆ∂');
            }
            return result.data;
        };
        
        const submitOrder = async (orderData, idToken) => {
            const orderDataForServer = {
                customerName: orderData.customerName.trim(),
                customerPhone: orderData.customerPhone.trim(),
                items: orderData.items.map(item => ({ name: item.name, quantity: item.quantity })),
                pickupTime: orderData.pickupTime,
                deliveryAddress: orderData.deliveryAddress.trim(),
                notes: orderData.notes.trim(),
                timestamp: new Date().toISOString(),
            };

            const payload = { 
                action: 'createOrder', 
                apiKey: API_KEY,
                idToken: idToken,
                orderData: orderDataForServer 
            };

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
            });

            if (!response.ok) throw new Error(`‰º∫ÊúçÂô®ÈåØË™§: ${response.status} ${response.statusText}`);
            return await response.json();
        };

        const getOrders = async (params) => {
            const payload = { 
                action: 'getOrders', 
                apiKey: API_KEY,
                ...params 
            };
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8',
                },
                body: JSON.stringify(payload),
                mode: 'cors',
            });
            if (!response.ok) throw new Error(`‰º∫ÊúçÂô®ÈåØË™§: ${response.status} ${response.statusText}`);
            return await response.json();
        };

        // --- From hooks/useLiff.ts ---
        const useLiff = () => {
            const [profile, setProfile] = useState(null);
            const [idToken, setIdToken] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [liffStatus, setLiffStatus] = useState('üîÑ ÂàùÂßãÂåñ LINE ÂäüËÉΩ‰∏≠...');
            const [statusType, setStatusType] = useState('info');
            const [isInClient, setIsInClient] = useState(false);

            const login = useCallback(() => {
                if (window.liff && !window.liff.isLoggedIn()) {
                    window.liff.login();
                }
            }, []);

            useEffect(() => {
                const initializeLiff = async () => {
                    try {
                        if (window.liff) {
                            await window.liff.init({ liffId: LIFF_ID });
                            setIsInClient(window.liff.isInClient());
                            if (window.liff.isLoggedIn()) {
                                setIsLoggedIn(true);
                                const [userProfile, token] = await Promise.all([
                                    window.liff.getProfile(),
                                    window.liff.getIDToken()
                                ]);
                                setProfile(userProfile);
                                setIdToken(token);
                                setLiffStatus(`üëã Ê≠°ËøéÔºå${userProfile.displayName}ÔºÅ`);
                                setStatusType('success');
                            } else {
                                if (window.liff.isInClient()) {
                                    setLiffStatus('Êú™ÁôªÂÖ• LINEÔºåÊ≠£Âú®ÂòóË©¶ÁôªÂÖ•...');
                                    window.liff.login();
                                } else {
                                    setLiffStatus('Ë´ãÁôªÂÖ• LINE ‰ª•Áç≤ÂæóÂÆåÊï¥ÂäüËÉΩ„ÄÇ');
                                    setStatusType('warning');
                                }
                            }
                        } else {
                            throw new Error('LIFF SDK not found');
                        }
                    } catch (error) {
                        console.error('LIFF initialization failed', error);
                        setLiffStatus('‚ö†Ô∏è LINE ÂäüËÉΩËºâÂÖ•Â§±ÊïóÔºå‰ΩÜÊÇ®‰ªçÂèØË®ÇÈ§ê„ÄÇ');
                        setStatusType('warning');
                    }
                };
                initializeLiff();
            }, []);

            return { profile, idToken, isLoggedIn, liffStatus, statusType, login, isInClient };
        };

        // --- From components/LoadingSpinner.tsx ---
        const LoadingSpinner = () => (
            <svg className="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        // --- From components/Notification.tsx ---
        const Notification = ({ message, type, visible, onClose }) => {
            if (!visible) return null;
            const typeClasses = {
                success: "bg-green-500 text-white",
                error: "bg-red-500 text-white",
                warning: "bg-yellow-500 text-white",
                info: "bg-blue-500 text-white"
            };
            return (
                <div className={`fixed top-5 right-5 max-w-sm p-4 rounded-lg shadow-lg z-50 transition-opacity duration-300 animate-slide-in ${typeClasses[type]}`}>
                    <div className="flex justify-between items-center">
                        <p className="text-sm font-medium whitespace-pre-wrap">{message}</p>
                        <button onClick={onClose} className="ml-4 text-xl font-bold leading-none">&times;</button>
                    </div>
                </div>
            );
        };

        // --- From components/HistoryPage.tsx ---
        const HistoryPage = ({ onBack, showNotification }) => {
            const { idToken, liffStatus, login, isInClient } = useLiff();
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 7);
                return d.toISOString().split('T')[0];
            });
            const [endDate, setEndDate] = useState(() => new Date().toISOString().split('T')[0]);
            const [orders, setOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [searched, setSearched] = useState(false);

            const isLineUser = useMemo(() => !!idToken, [idToken]);
            const isLiffInitializing = useMemo(() => liffStatus.includes('ÂàùÂßãÂåñ'), [liffStatus]);

            const handleSearch = async () => {
                if (!idToken) {
                    showNotification('ÂÉÖÈôê LINE Áî®Êà∂Êü•Ë©¢„ÄÇ', 'error');
                    return;
                }
                
                setIsLoading(true);
                setSearched(true);
                setOrders([]);
                
                try {
                    const params = {
                        idToken: idToken,
                        startDate: startDate,
                        endDate: endDate
                    };

                    const result = await getOrders(params);

                    if (result.success && Array.isArray(result.data)) {
                        setOrders(result.data.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()));
                    } else {
                        throw new Error(result.message || 'Êü•Ë©¢Â§±Êïó');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        showNotification('Êü•Ë©¢Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÁ∂≤Ë∑ØÈÄ£Á∑ö„ÄÇ', 'error');
                    } else if (error instanceof Error) {
                        showNotification(`Êü•Ë©¢Â§±ÊïóÔºö${error.message}`, 'error');
                    } else {
                        showNotification('Êü•Ë©¢ÊôÇÁôºÁîüÊú™Áü•ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                    }
                    setOrders([]);
                } finally {
                    setIsLoading(false);
                }
            };

            const formatItems = (items) => {
                return typeof items === 'string' ? items : 'È†ÖÁõÆË≥áË®äÈåØË™§';
            };

            const renderContent = () => {
                if (isLiffInitializing) {
                    return (
                        <div className="text-center py-10 flex flex-col items-center justify-center text-gray-600">
                            <LoadingSpinner />
                            <p className="mt-3 text-sm">{liffStatus}</p>
                        </div>
                    );
                }

                if (!isLineUser) {
                    return (
                        <div className="text-center text-gray-600 py-10 px-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div className="text-4xl mb-4">üîê</div>
                            <h3 className="text-lg font-bold text-gray-800 mb-2">ÊúÉÂì°ÂäüËÉΩÔºöË®ÇÂñÆÁ¥ÄÈåÑ</h3>
                            <p className="text-sm">ÁÇ∫‰∫Ü‰øùË≠∑ÊÇ®ÁöÑÈö±ÁßÅÔºåÊü•Ë©¢Ê≠∑Âè≤Ë®ÇÂñÆÂäüËÉΩÂÉÖÈôêÊúÉÂì°‰ΩøÁî®„ÄÇ</p>
                            
                            {!isInClient && (
                                <div className="mt-6">
                                    <p className="text-sm mb-4">Ë´ãÁôªÂÖ•ÊÇ®ÁöÑ LINE Â∏≥Ëôü‰ª•ÁπºÁ∫å„ÄÇ</p>
                                    <button onClick={login} className="w-full bg-[#00c300] hover:bg-[#00a300] text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center transition-transform transform hover:scale-105">
                                        <svg className="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20"><path d="M17.9 11.3C17.4 15 14.3 18 10.4 18c-3.9 0-7.3-3-7.8-6.7H2v-2h.6c.5-3.7 3.9-6.7 7.8-6.7 3.9 0 7.3 3 7.8 6.7H18v2h-.1zM6.3 11.1c0-1 .8-1.8 1.8-1.8.9 0 1.7.8 1.7 1.8s-.8 1.8-1.7 1.8c-1 0-1.8-.8-1.8-1.8zm5.6 0c0-1 .8-1.8 1.7-1.8.9 0 1.7.8 1.7 1.8s-.8 1.8-1.7 1.8c-1 0-1.7-.8-1.7-1.8z"></path></svg>
                                        <span>‰ΩøÁî® LINE ÁôªÂÖ•</span>
                                    </button>
                                </div>
                            )}
                            {isInClient && (
                                <p className="text-sm mt-4">Á≥ªÁµ±Ê≠£Âú®ÂòóË©¶Ëá™ÂãïÁôªÂÖ•ÔºåË´ãÁ®çÂÄô...</p>
                            )}
                        </div>
                    );
                }

                return (
                    <React.Fragment>
                        <div className="p-4 bg-gray-50 rounded-lg border">
                            <p className="text-sm text-gray-700 mb-3 text-center bg-green-100 p-2 rounded-md border border-green-200">
                                ÊÇ®Â∑≤ÈÄèÈÅé LINE ÁôªÂÖ•ÔºåÂ∞áËá™ÂãïÊü•Ë©¢Ê≠§Â∏≥ËôüÁöÑË®ÇÂñÆ„ÄÇ
                            </p>
                            <div className="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">ÈñãÂßãÊó•Êúü</label>
                                    <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">ÁµêÊùüÊó•Êúü</label>
                                    <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full p-2 border border-gray-300 rounded-md" />
                                </div>
                            </div>
                            <div>
                                <button onClick={handleSearch} disabled={isLoading} className="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-400 flex items-center justify-center">
                                    {isLoading ? (
                                        <React.Fragment>
                                            <LoadingSpinner />
                                            <span>Êü•Ë©¢‰∏≠...</span>
                                        </React.Fragment>
                                    ) : 'üîç Êü•Ë©¢'}
                                </button>
                            </div>
                        </div>

                        <div className="space-y-4 max-h-[60vh] overflow-y-auto p-1 mt-4">
                            {!isLoading && !searched && (
                                <div className="text-center text-gray-500 py-10 italic">
                                    <p>Ë´ãÈÅ∏ÊìáÊó•ÊúüÁØÑÂúçÈÄ≤Ë°åÊü•Ë©¢ÊÇ®ÁöÑÊ≠∑Âè≤Ë®ÇÂñÆ„ÄÇ</p>
                                </div>
                            )}
                            {!isLoading && searched && orders.length === 0 && (
                                <p className="text-center text-gray-500 py-10 italic">Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®ÇÂñÆ</p>
                            )}
                            {!isLoading && orders.map(order => (
                                <div key={order.orderId} className="bg-white p-4 rounded-lg shadow border border-gray-200">
                                    <div className="flex justify-between items-start border-b pb-2 mb-2">
                                        <div>
                                            <p className="text-xs text-gray-500">Ë®ÇÂñÆÁ∑®Ëôü</p>
                                            <p className="font-bold text-gray-800 text-sm">{order.orderId}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-xs text-gray-500">Ë®ÇÂñÆÈáëÈ°ç</p>
                                            <p className="font-bold text-green-600 text-lg">${order.totalAmount}</p>
                                        </div>
                                    </div>
                                    <div className="text-sm space-y-1 text-gray-600">
                                        <p><strong>‰∏ãÂñÆÊôÇÈñì:</strong> {new Date(order.createdAt).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</p>
                                        <p><strong>È†êË®àÂèñÈ§ê:</strong> {new Date(order.pickupTime).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}</p>
                                        <p><strong>Ë®ÇÂñÆÂÖßÂÆπ:</strong> {formatItems(order.items)}</p>
                                        {order.deliveryAddress && <p><strong>Â§ñÈÄÅÂú∞ÂùÄ:</strong> {order.deliveryAddress}</p>}
                                        {order.notes && <p><strong>ÂÇôË®ª:</strong> {order.notes}</p>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </React.Fragment>
                );
            };

            return (
                <div className="animate-fade-in">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Ë®ÇÂñÆÁ¥ÄÈåÑÊü•Ë©¢</h2>
                        <button onClick={onBack} className="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 py-1 px-3 rounded-lg">ËøîÂõûË®ÇÈ§ê</button>
                    </div>
                    {renderContent()}
                </div>
            );
        };

        // --- From components/SuccessPage.tsx ---
        const SuccessPage = ({ orderData, onNewOrder, showNotification }) => {
            const formatDisplayTime = (timestamp) => new Date(timestamp).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            const formatOrderItems = (items) => items.map(item => `${item.icon} ${item.name} x${item.quantity} ($${item.price * item.quantity})`).join(', ');

            const shareTextContent = useMemo(() => {
                const itemsText = orderData.items.map(item => `‚ñ´Ô∏è ${item.icon} ${item.name} x${item.quantity} - $${item.price * item.quantity}`).join('\n');
                return `üçΩÔ∏è Âè∞ÁÅ£Â∞èÂêÉÂ∫ó - Ë®ÇÂñÆÁ¢∫Ë™ç\n\nüìã Ë®ÇÂñÆÁ∑®ËôüÔºö${orderData.orderId}\nüë§ È°ßÂÆ¢ÂßìÂêçÔºö${orderData.customerName}\nüìû ËÅØÁµ°ÈõªË©±Ôºö${orderData.customerPhone}\n\nüì¶ Ë®ÇÂñÆÂÖßÂÆπÔºö\n${itemsText}\n\nüí∞ ÊúÄÁµÇÁ∏ΩÈáëÈ°çÔºö$${orderData.totalAmount}\n‚è∞ ÂèñÈ§êÊôÇÈñìÔºö${formatDisplayTime(orderData.pickupTime)}\nüìç ${orderData.deliveryAddress ? `Â§ñÈÄÅÂú∞ÂùÄÔºö${orderData.deliveryAddress}` : 'Ëá™Âèñ'}\nüìù ÂÇôË®ªÔºö${orderData.notes || 'ÁÑ°'}\n\nüìç ÂèñÈ§êÂú∞ÂùÄÔºöÂè∞ÁÅ£Â∞èÂêÉÂ∫ó\nüïí ÁáüÊ•≠ÊôÇÈñìÔºö10:00-21:00\nüìû ËÅØÁµ°ÈõªË©±Ôºö02-1234-5678`;
            }, [orderData]);

            const copyShareText = () => {
                navigator.clipboard.writeText(shareTextContent)
                    .then(() => showNotification('Ë®ÇÂñÆË≥áË®äÂ∑≤Ë§áË£ΩÔºÅ', 'success'))
                    .catch(err => {
                        console.error('Copy failed', err);
                        showNotification('Ë§áË£ΩÂ§±Êïó', 'error');
                    });
            };

            return (
                <div className="text-center p-5 animate-fade-in">
                    <div className="text-6xl mb-5">‚úÖ</div>
                    <h3 className="text-2xl font-bold text-green-600 mb-4">Ë®ÇÂñÆÊèê‰∫§ÊàêÂäüÔºÅ</h3>
                    <div className="bg-gray-50 p-4 rounded-lg my-5 text-left border">
                        <p><strong>Ë®ÇÂñÆÁ∑®ËôüÔºö</strong><span>{orderData.orderId}</span></p>
                        <p><strong>È°ßÂÆ¢ÂßìÂêçÔºö</strong><span>{orderData.customerName}</span></p>
                        <p><strong>ÊúÄÁµÇÁ∏ΩÈáëÈ°çÔºö</strong>$<span>{orderData.totalAmount}</span></p>
                        <p><strong>ÂèñÈ§êÊôÇÈñìÔºö</strong><span>{formatDisplayTime(orderData.pickupTime)}</span></p>
                        <p><strong>Ë®ÇÂñÆÂÖßÂÆπÔºö</strong><span>{formatOrderItems(orderData.items)}</span></p>
                    </div>
                    <div className="my-8">
                        <p className="text-lg font-bold mb-4">üì± ÂàÜ‰∫´Ë®ÇÂñÆË≥áË®ä</p>
                        <a href={`https://line.me/R/msg/text/?${encodeURIComponent(shareTextContent)}`} target="_blank" rel="noopener noreferrer" className="inline-block my-4 p-2.5 bg-[#06c755] rounded-lg">
                            <img src="https://scdn.line-apps.com/n/line_add_friends/btn/zh-Hant.png" alt="ÂàÜ‰∫´Âà∞ LINE" className="h-10" />
                        </a>
                        <div className="mt-6">
                            <p className="text-sm text-gray-600 mb-2">ÊàñË§áË£Ω‰ª•‰∏ãË®ÇÂñÆË≥áË®äÔºö</p>
                            <textarea readOnly value={shareTextContent} rows={6} className="w-full p-3 border border-gray-300 rounded-lg text-sm bg-gray-100"></textarea>
                            <button onClick={copyShareText} className="bg-blue-500 text-white border-none py-2 px-5 rounded-md cursor-pointer mt-2.5 hover:bg-blue-600">üìã Ë§áË£ΩË®ÇÂñÆË≥áË®ä</button>
                        </div>
                    </div>
                    <button onClick={onNewOrder} className="bg-green-600 text-white border-none py-3 px-8 rounded-md cursor-pointer text-base mt-5 hover:bg-green-700">üìù ÂÜçË®Ç‰∏ÄÂñÆ</button>
                </div>
            );
        };

        // --- From components/OrderPage.tsx ---
        const OrderPage = ({ menuItems, onSubmitOrder, showNotification, onViewHistory }) => {
            const { profile, idToken, liffStatus, statusType } = useLiff();
            const [cart, setCart] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [pickupTime, setPickupTime] = useState('');
            const [deliveryAddress, setDeliveryAddress] = useState('');
            const [notes, setNotes] = useState('');
            const [phoneError, setPhoneError] = useState('');
            const [timeError, setTimeError] = useState('');
            
            const getDefaultPickupTime = () => {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 30);
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                return now.toISOString().slice(0, 16);
            };

            useEffect(() => {
                setPickupTime(getDefaultPickupTime());
            }, []);

            useEffect(() => {
                if (profile?.displayName) {
                    setCustomerName(profile.displayName);
                }
            }, [profile]);

            const { subtotal, deliveryFee, totalAmount } = useMemo(() => {
                const sub = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const fee = deliveryAddress.trim() ? DELIVERY_FEE : 0;
                return { subtotal: sub, deliveryFee: fee, totalAmount: sub + fee };
            }, [cart, deliveryAddress]);

            const handleAddToCart = useCallback((itemName) => {
                const menuItem = menuItems.find(item => item.name === itemName);
                if (!menuItem) return;

                if (menuItem.status === 'Â∑≤ÂîÆÂÆå') {
                    showNotification(`${itemName} Â∑≤ÂîÆÂÆåÔºåÁÑ°Ê≥ïÂä†ÂÖ•`, 'error');
                    return;
                }

                setCart(prevCart => {
                    const existingItem = prevCart.find(item => item.name === itemName);
                    if (existingItem) {
                        return prevCart.map(item => item.name === itemName ? { ...item, quantity: item.quantity + 1 } : item);
                    }
                    return [...prevCart, { ...menuItem, quantity: 1 }];
                });
                showNotification(`Â∑≤Ê∑ªÂä† ${itemName}`, 'success');
            }, [showNotification, menuItems]);

            const handleQuantityChange = useCallback((itemName, change) => {
                setCart(prevCart => {
                    const itemIndex = prevCart.findIndex(item => item.name === itemName);
                    if (itemIndex === -1) return prevCart;
                    
                    const newQuantity = prevCart[itemIndex].quantity + change;
                    if (newQuantity <= 0) {
                        showNotification(`Â∑≤ÁßªÈô§ ${itemName}`, 'warning');
                        return prevCart.filter(item => item.name !== itemName);
                    }
                    return prevCart.map(item =>
                        item.name === itemName ? { ...item, quantity: newQuantity } : item
                    );
                });
            }, [showNotification]);
            
            const handleClearCart = useCallback(() => {
                if (window.confirm('ÊÇ®Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫Ë≥ºÁâ©ËªäÂóéÔºü')) {
                    setCart([]);
                    showNotification('Ë≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫', 'warning');
                }
            }, [showNotification]);

            const validateForm = () => {
                let isValid = true;
                setPhoneError('');
                setTimeError('');

                if (!/^09\d{8}$/.test(customerPhone)) {
                    setPhoneError('Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑ10‰ΩçÊâãÊ©üËôüÁ¢º (09ÈñãÈ†≠)');
                    isValid = false;
                }

                const selectedTime = new Date(pickupTime);
                const minTime = new Date(new Date().getTime() + 29 * 60000);
                const maxTime = new Date(new Date().getTime() + 7 * 24 * 60 * 60000);

                if (!pickupTime || selectedTime < minTime || selectedTime > maxTime) {
                    setTimeError('Ë´ãÈÅ∏ÊìáÊúâÊïàÁöÑÂèñÈ§êÊôÇÈñì (30ÂàÜÈêòÂæåËá≥7Â§©ÂÖß)');
                    isValid = false;
                }
                
                if (cart.length === 0) {
                    showNotification('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºåË´ãÊ∑ªÂä†È§êÈªû', 'error');
                    isValid = false;
                }
                return isValid;
            };

            const handleSubmit = async () => {
                if (!validateForm()) return;
                setIsLoading(true);
                try {
                    await onSubmitOrder({ customerName, customerPhone, items: cart, pickupTime, deliveryAddress, notes }, idToken);
                } catch (error) {
                    // Parent handles notification
                } finally {
                    setIsLoading(false);
                }
            };
            
            const statusClasses = { info: 'bg-blue-100 border-blue-400 text-blue-800', success: 'bg-green-100 border-green-400 text-green-800', warning: 'bg-yellow-100 border-yellow-400 text-yellow-800', error: 'bg-red-100 border-red-400 text-red-800' };

            return (
                <div className="animate-fade-in">
                    <div className={`p-3 rounded-lg text-sm text-center border ${statusClasses[statusType]}`}>{liffStatus}</div>
                    <button onClick={onViewHistory} className="w-full text-center p-2.5 border border-blue-500 text-blue-600 rounded-md text-sm hover:bg-blue-500 hover:text-white transition-colors duration-200 mt-4">üïí Êü•Ë©¢Ê≠∑Âè≤Ë®ÇÂñÆ</button>
                    <div className="space-y-4 mt-4">
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">ÂßìÂêç <span className="text-red-500">*</span></label>
                            <input type="text" value={customerName} onChange={(e) => setCustomerName(e.target.value)} placeholder="Ëá™ÂãïÂ∏∂ÂÖ• LINE ÂêçÁ®±" className="w-full p-3 border border-gray-300 rounded-lg text-sm transition-all duration-200 focus:ring-green-500 focus:border-green-500"/>
                        </div>
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">ÊâãÊ©üËôüÁ¢º <span className="text-red-500">*</span></label>
                            <input type="tel" value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} placeholder="0912345678" className={`w-full p-3 border rounded-lg text-sm transition-all duration-200 focus:ring-green-500 focus:border-green-500 ${phoneError ? 'border-red-500' : 'border-gray-300'}`}/>
                            {phoneError && <p className="text-red-500 text-xs mt-1">{phoneError}</p>}
                        </div>
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">ÂèñÈ§êÊôÇÈñì <span className="text-red-500">*</span></label>
                            <input type="datetime-local" value={pickupTime} onChange={(e) => setPickupTime(e.target.value)} className={`w-full p-3 border rounded-lg text-sm transition-all duration-200 focus:ring-green-500 focus:border-green-500 ${timeError ? 'border-red-500' : 'border-gray-300'}`}/>
                            {timeError && <p className="text-red-500 text-xs mt-1">{timeError}</p>}
                        </div>
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">Â§ñÈÄÅÂú∞Èªû (ÈÅ∏Â°´)</label>
                            <input type="text" value={deliveryAddress} onChange={(e) => setDeliveryAddress(e.target.value)} placeholder="Â¶ÇÈúÄÂ§ñÈÄÅË´ãÂ°´ÂØ´Âú∞ÂùÄ" className="w-full p-3 border border-gray-300 rounded-lg text-sm transition-all duration-200 focus:ring-green-500 focus:border-green-500"/>
                            <p className="text-xs text-gray-500 mt-1 italic">{`‚Äª Â°´ÂØ´Âú∞ÂùÄÂ∞áÁî±ÂæåÁ´ØË®àÁÆó $${DELIVERY_FEE} Â§ñÈÄÅË≤ª`}</p>
                        </div>
                        <div>
                            <label className="block mb-2 font-bold text-gray-700 text-sm">ÂÇôË®ª (ÈÅ∏Â°´)</label>
                            <textarea value={notes} onChange={(e) => setNotes(e.target.value)} rows={2} placeholder="‰æãÂ¶ÇÔºö‰∏çË¶ÅÈ¶ôËèú„ÄÅÂä†Ëæ£Á≠â" className="w-full p-3 border border-gray-300 rounded-lg text-sm transition-all duration-200 focus:ring-green-500 focus:border-green-500"></textarea>
                        </div>
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                        <h2 className="text-center text-lg font-bold text-gray-800 mb-4 relative pb-2">üìù ÈÅ∏ÊìáÈ§êÈªû<span className="absolute bottom-0 left-1/4 right-1/4 h-0.5 bg-green-500 rounded-full"></span></h2>
                        <select 
                            onChange={(e) => { if (e.target.value) handleAddToCart(e.target.value); e.target.value = ''; }} 
                            className="w-full p-3 border border-gray-300 rounded-lg text-sm mb-4 focus:ring-green-500 focus:border-green-500"
                        >
                            <option value="">-- Ë´ãÈÅ∏ÊìáÈ§êÈªû --</option>
                            {menuItems.map(item => (
                                <option key={item.name} value={item.name} disabled={item.status === 'Â∑≤ÂîÆÂÆå'}>
                                    {item.icon} {item.name} - ${item.price} {item.status === 'Â∑≤ÂîÆÂÆå' ? '(Êú¨Êó•ÂîÆÂÆå)' : ''}
                                </option>
                            ))}
                        </select>
                        <div className="p-3 bg-white rounded-md">
                            <p className="text-xs text-gray-500 mb-2">Âø´ÈÄüÈÅ∏ÊìáÔºö</p>
                            <div className="grid grid-cols-2 gap-2">
                                {menuItems.slice(0, 4).map(item => (
                                    <button 
                                        key={item.name} 
                                        onClick={() => handleAddToCart(item.name)}
                                        disabled={item.status === 'Â∑≤ÂîÆÂÆå'}
                                        className={`w-full text-left p-2 border rounded-md text-xs transition-colors duration-200 ${
                                            item.status === 'Â∑≤ÂîÆÂÆå' 
                                            ? 'border-gray-300 bg-gray-100 text-gray-400 cursor-not-allowed' 
                                            : 'border-green-500 text-green-600 hover:bg-green-500 hover:text-white'
                                        }`}
                                    >
                                        {item.icon} {item.name} {item.status === 'Â∑≤ÂîÆÂÆå' ? '(ÂîÆÂÆå)' : ''}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200 mt-4">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold text-gray-800">üõí Ë®ÇÂñÆÊòéÁ¥∞</h2>
                            {cart.length > 0 && (
                                <button onClick={handleClearCart} className="text-xs bg-red-100 text-red-600 hover:bg-red-500 hover:text-white font-semibold py-1 px-3 rounded-full transition-colors duration-200 flex items-center gap-1">
                                    üóëÔ∏è <span>Ê∏ÖÁ©∫</span>
                                </button>
                            )}
                        </div>
                        <div>
                            {cart.length === 0 ? (<p className="text-center text-gray-500 py-4 italic">Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>) : (cart.map(item => (
                                <div key={item.name} className="flex justify-between items-center py-3 border-b border-gray-200 last:border-b-0">
                                    <div>
                                        <p className="font-bold text-gray-800">{item.icon} {item.name}</p>
                                        <p className="text-xs text-gray-500">${item.price} x {item.quantity} = ${item.price * item.quantity}</p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button onClick={() => handleQuantityChange(item.name, -1)} className="w-7 h-7 bg-green-500 text-white rounded-full font-bold text-sm flex items-center justify-center hover:bg-green-600 transition-transform transform hover:scale-110">-</button>
                                        <span className="w-8 text-center font-bold">{item.quantity}</span>
                                        <button onClick={() => handleQuantityChange(item.name, 1)} className="w-7 h-7 bg-green-500 text-white rounded-full font-bold text-sm flex items-center justify-center hover:bg-green-600 transition-transform transform hover:scale-110">+</button>
                                        <button onClick={() => handleQuantityChange(item.name, -item.quantity)} className="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600 transition">ÁßªÈô§</button>
                                    </div>
                                </div>
                            )))}
                        </div>
                    </div>
                    
                    <div className="bg-green-50 p-4 rounded-lg border border-green-200 space-y-2 mt-4">
                        <div className="flex justify-between text-sm text-gray-600"><span>È§êÈªûÁ∏ΩË®à:</span><span>${subtotal}</span></div>
                        <div className="flex justify-between text-sm text-gray-600"><span>Â§ñÈÄÅË≤ª:</span><span>${deliveryFee}</span></div>
                        <div className="flex justify-between font-bold text-lg text-gray-800 border-t border-gray-300 pt-3 mt-3"><span>È†ê‰º∞Á∏ΩÈáëÈ°ç:</span><span>${totalAmount}</span></div>
                    </div>
                    
                    <div className="mt-6">
                        <button onClick={handleSubmit} disabled={cart.length === 0 || isLoading} className="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-all duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none flex items-center justify-center">
                            {isLoading ? <React.Fragment><LoadingSpinner /><span>ËôïÁêÜ‰∏≠...</span></React.Fragment> : <span>‚úÖ ÈÄÅÂá∫Ë®ÇÂñÆ</span>}
                        </button>
                    </div>
                </div>
            );
        };

        // --- From App.tsx ---
        const App = () => {
            const [view, setView] = useState('order'); // 'order', 'success', 'history'
            const [submittedOrder, setSubmittedOrder] = useState(null);
            const [notification, setNotification] = useState({ message: '', type: 'success', visible: false });
            const [menuItems, setMenuItems] = useState([]);
            const [isMenuLoading, setIsMenuLoading] = useState(true);
            const [menuError, setMenuError] = useState(null);

            useEffect(() => {
                console.log("%cSTOP!", "color: red; font-size: 48px; font-weight: bold; -webkit-text-stroke: 1px black;");
                console.log("%cThis is a browser feature intended for developers. If someone told you to copy-paste something here to enable a feature or 'hack' this system, it is a scam.", "font-size: 18px;");
                console.log("%cThis ordering system is proprietary. Unauthorized copying, distribution, or use of this code is strictly prohibited.", "font-size: 16px; font-weight: bold; color: #888;");
            }, []);

            const showNotification = useCallback((message, type = 'success', duration = 4000) => {
                setNotification({ message, type, visible: true });
                setTimeout(() => setNotification(prev => ({ ...prev, visible: false })), duration);
            }, []);

            useEffect(() => {
                const fetchMenu = async () => {
                    try {
                        const items = await getMenu();
                        setMenuItems(items);
                        setMenuError(null);
                    } catch (error) {
                        console.error("Failed to fetch menu:", error);
                        setMenuError(error.message);
                        showNotification(`ËèúÂñÆËºâÂÖ•Â§±Êïó: ${error.message}`, 'error', 10000);
                    } finally {
                        setIsMenuLoading(false);
                    }
                };
                fetchMenu();
            }, [showNotification]);


            const handleSubmitOrder = async (orderData, idToken) => {
                try {
                    const result = await submitOrder(orderData, idToken);
                    if (result.success) {
                        const finalOrderData = { ...orderData, orderId: result.data?.orderId || 'N/A', totalAmount: result.data.totalAmount };
                        setSubmittedOrder(finalOrderData);
                        setView('success');
                        if (idToken && window.liff?.isInClient()) {
                            const itemsText = orderData.items.map(item => `${item.icon} ${item.name} x${item.quantity}`).join('\n');
                            const formattedTime = new Date(orderData.pickupTime).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                            await window.liff.sendMessages([{ type: 'text', text: `ÊÑüË¨ùË®ÇË≥ºÔºÅ\n\nüìã Ë®ÇÂñÆÁ∑®ËôüÔºö${finalOrderData.orderId}\nüë§ È°ßÂÆ¢ÂßìÂêçÔºö${orderData.customerName}\n\nüì¶ Ë®ÇÂñÆÂÖßÂÆπÔºö\n${itemsText}\n\nüí∞ Á∏ΩÈáëÈ°çÔºö$${finalOrderData.totalAmount}\n‚è∞ ÂèñÈ§êÊôÇÈñìÔºö${formattedTime}` }]);
                        }
                    } else { throw new Error(result.message || 'Ë®ÇÂñÆÊèê‰∫§Â§±Êïó'); }
                } catch (error) {
                    console.error('Order submission error:', error);
                    if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
                        showNotification('Ë®ÇÂñÆÊèê‰∫§Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÁ∂≤Ë∑ØÈÄ£Á∑öÂæåÂÜçË©¶‰∏ÄÊ¨°„ÄÇ', 'error');
                    } else if (error instanceof Error) {
                        showNotification(`Ë®ÇÂñÆÊèê‰∫§Â§±ÊïóÔºö${error.message}`, 'error');
                    } else {
                        showNotification('Ë®ÇÂñÆÊèê‰∫§ÊôÇÁôºÁîüÊú™Áü•ÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ', 'error');
                    }
                    throw error;
                }
            };

            const handleNewOrder = () => {
                setSubmittedOrder(null);
                setView('order');
            };

            const renderContent = () => {
                if (isMenuLoading) {
                    return (
                        <div className="text-center py-20 flex flex-col items-center justify-center text-gray-600">
                            <LoadingSpinner />
                            <p className="mt-3 text-sm">Ê≠£Âú®ËºâÂÖ•ÊúÄÊñ∞ËèúÂñÆ...</p>
                        </div>
                    );
                }

                if (menuError) {
                    return (
                        <div className="text-center py-10 text-red-700 bg-red-50 p-4 rounded-lg border border-red-200">
                            <p className="font-bold text-lg">‚ö†Ô∏è ËèúÂñÆËºâÂÖ•Â§±Êïó</p>
                            <p className="text-sm mt-2">{menuError}</p>
                            <p className="text-xs mt-3 text-gray-500">Ë´ãÁ®çÂæåÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÔºåÊàñÁõ¥Êé•ËÅØÁπ´Â∫óÂÆ∂„ÄÇ</p>
                        </div>
                    );
                }

                switch(view) {
                    case 'history':
                        return <HistoryPage onBack={() => setView('order')} showNotification={showNotification} />;
                    case 'success':
                        return submittedOrder && <SuccessPage orderData={submittedOrder} onNewOrder={handleNewOrder} showNotification={showNotification} />;
                    case 'order':
                    default:
                        return <OrderPage menuItems={menuItems} onSubmitOrder={handleSubmitOrder} showNotification={showNotification} onViewHistory={() => setView('history')} />;
                }
            }

            return (
                <div className="p-4 min-h-screen flex items-center justify-center">
                    <div className="container max-w-md mx-auto bg-white rounded-2xl shadow-2xl overflow-hidden">
                        <div className="bg-[#fff3cd] border border-[#ffeaa7] rounded-t-2xl p-2.5 text-xs text-center text-[#856404]">
                            <span role="img" aria-label="lock">üîí</span> ÂÆâÂÖ®Ë®ÇÈ§êÁ≥ªÁµ± - 24Â∞èÊôÇÊé•ÂèóÈ†êË®Ç
                        </div>

                        <header className="bg-green-500 text-white p-5 text-center relative">
                            <h1 className="text-2xl font-bold mb-1">üçú Âè∞ÁÅ£Â∞èÂêÉÂ∫ó</h1>
                            <p className="text-sm opacity-90">LINE Âø´ÈÄüË®ÇÈ§ê - 24Â∞èÊôÇÊúçÂãô</p>
                            <div className="absolute bottom-0 left-1/4 right-1/4 h-1 bg-white bg-opacity-30 rounded-full"></div>
                        </header>

                        <main className="p-5 space-y-4">
                            <Notification message={notification.message} type={notification.type} visible={notification.visible} onClose={() => setNotification(prev => ({ ...prev, visible: false }))} />
                            {renderContent()}
                        </main>
                        
                        <footer className="bg-gray-100 p-4 text-center text-xs text-gray-500 border-t border-gray-200">
                            <p>üìç ÁáüÊ•≠ÊôÇÈñì: 10:00 - 21:00 | üìû ËÅØÁµ°ÈõªË©±: 02-1234-5678</p>
                            <p className="mt-2 opacity-70">Á≥ªÁµ±ÁâàÊú¨: 10.0.0-DYNAMIC-MENU</p>
                            <p className="mt-1 opacity-50">&copy; {new Date().getFullYear()} Âè∞ÁÅ£Â∞èÂêÉÂ∫ó. All Rights Reserved.</p>
                        </footer>
                    </div>
                </div>
            );
        };

        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(
                <React.StrictMode>
                    <App />
                </React.StrictMode>
            );
        }
    </script>
</body>
</html>
