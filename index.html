<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>台灣小吃店 - LINE訂餐系統</title>
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@google/generative-ai/dist/index.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* General Reset & Body Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #f0fdf4, #eff6ff);
            min-height: 100vh;
            padding: 24px 12px;
            box-sizing: border-box;
        }
        #root {
            height: 100%;
        }

        /* Main App Container */
        .app-container {
            max-width: 28rem;
            margin: auto;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: flex;
            flex-direction: column;
            min-height: 100dvh;
        }

        .screen-main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Header */
        .header {
            background-color: #16a34a; /* bg-green-600 */
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }
        .header-decorator {
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 9999px;
        }
        .back-button {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .back-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1rem;
            color: #6b7280;
            font-size: 0.75rem;
            border-top: 1px solid #e5e7eb;
            background-color: #f9fafb;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }

        /* Section Title */
        .section-title {
            font-size: 1.125rem;
            font-weight: bold;
            text-align: center;
            color: #1f2937;
            margin-bottom: 24px;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 25%;
            right: 25%;
            height: 2px;
            background-color: #22c55e;
        }
        
        /* Form Group & Inputs */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #374151;
            font-size: 0.875rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: box-shadow 0.2s, border-color 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }
        .form-group input.error, .form-group textarea.error {
            border-color: #ef4444;
        }
        .form-group input.error:focus, .form-group textarea.error:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5);
        }
        .error-message { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; }

        /* LIFF Status */
        .liff-status {
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            text-align: center;
            border-width: 1px;
        }
        .liff-status.initializing { background-color: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; }
        .liff-status.ready { background-color: #dcfce7; border-color: #4ade80; color: #166534; }
        .liff-status.logged_out { background-color: #fefce8; border-color: #facc15; color: #854d0e; }
        .liff-status.error { background-color: #fee2e2; border-color: #f87171; color: #991b1b; }

        /* Rich Menu Dashboard */
        .rich-menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 0.75rem;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: transform 0.2s, box-shadow 0.2s;
            background-image: linear-gradient(rgba(255, 255, 255, 0.07), rgba(0, 0, 0, 0.07));
            border: none;
            cursor: pointer;
        }
        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .menu-button svg {
            width: 2.25rem;
            height: 2.25rem;
        }
        .menu-button span {
            margin-top: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .bg-green-600 { background-color: #16a34a; } .bg-green-600:hover { background-color: #15803d; }
        .bg-blue-500 { background-color: #3b82f6; } .bg-blue-500:hover { background-color: #2563eb; }
        .bg-orange-500 { background-color: #f97316; } .bg-orange-500:hover { background-color: #ea580c; }
        .bg-purple-500 { background-color: #8b5cf6; } .bg-purple-500:hover { background-color: #7c3aed; }
        .bg-red-600 { background-color: #c53030; } .bg-red-600:hover { background-color: #a02828; }
        .bg-yellow-600 { background-color: #d69e2e; } .bg-yellow-600:hover { background-color: #b08225; }

        /* Menu Section */
        .menu-container {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            margin: 1rem 0;
        }
        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .quick-add-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .quick-add-btn {
            width: 100%;
            text-align: left;
            padding: 0.5rem;
            border: 1px solid #22c55e;
            color: #166534;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem;
        }
        .quick-add-btn:hover { background-color: #22c55e; color: white; }

        /* Cart Section */
        .cart-container {
            background-color: #fefce8;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fde68a;
            margin: 1rem 0;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #fde68a;
        }
        .cart-item:last-child { border-bottom: none; }
        .quantity-controls { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-btn {
            width: 1.75rem; height: 1.75rem; display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; color: white; transition: transform 0.2s, background-color 0.2s;
        }
        .quantity-btn:hover { transform: scale(1.1); }
        .quantity-btn svg { width: 1rem; height: 1rem; }
        .plus-minus-btn { background-color: #22c55e; } .plus-minus-btn:hover { background-color: #16a34a; }
        .trash-btn { background-color: #ef4444; margin-left: 0.5rem; } .trash-btn:hover { background-color: #dc2626; }
        .quantity-display { width: 1.5rem; text-align: center; font-weight: bold; }

        /* Order Summary */
        .summary-container {
            background-color: #f0fdf4; padding: 1rem; border-radius: 0.5rem;
            border: 1px solid #bbf7d0; margin: 1rem 0; font-size: 0.875rem;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%; margin-top: 1rem; padding: 1rem; background-color: #16a34a; color: white;
            border-radius: 0.5rem; font-weight: bold; font-size: 1.125rem;
            transition: all 0.3s;
        }
        .submit-btn:hover { background-color: #15803d; }
        .submit-btn:disabled {
            background-color: #9ca3af; cursor: not-allowed;
            transform: none;
        }
        .submit-btn:hover:not(:disabled) { transform: scale(1.05); }

        /* Loading Overlay */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50;
        }
        .spinner {
            width: 4rem; height: 4rem; border: 4px solid #e5e7eb;
            border-top-color: #22c55e; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text { color: white; margin-top: 1rem; font-size: 1.125rem; }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed; top: 1.25rem; right: 1.25rem; width: 91.666667%; max-width: 24rem;
            padding: 1rem; border-radius: 0.5rem; color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }
        .notification-toast.hidden { transform: translateX(110%); }
        .notification-toast.success { background-color: #22c55e; }
        .notification-toast.error { background-color: #ef4444; }
        .notification-toast.warning { background-color: #f59e0b; }
        .notification-toast p:first-child { font-weight: bold; }
        .notification-toast p:last-child { font-size: 0.875rem; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    (function() {
        // Mock 'process' for browser environment as per Gemini API guidelines
        window.process = {
            env: {
                // IMPORTANT: This API_KEY is a placeholder. The execution environment
                // is expected to replace this value. For local testing without a backend,
                // you can paste your key here, but DO NOT commit it to version control.
                API_KEY: '' 
            }
        };

        const { useState, useEffect, useCallback, useMemo, StrictMode } = React;
        const { createRoot } = ReactDOM;

        // --- From constants.tsx ---
        const LIFF_ID = '2008316489-6nMjb0KX';
        const DELIVERY_FEE = 30;
        const MENU_ITEMS = [
            { id: '1', name: '滷肉飯', price: 35, icon: '🍚' },
            { id: '2', name: '雞肉飯', price: 40, icon: '🍗' },
            { id: '3', name: '蚵仔煎', price: 65, icon: '🍳' },
            { id: '4', name: '大腸麵線', price: 50, icon: '🍜' },
            { id: '5', name: '珍珠奶茶', price: 45, icon: '🥤' },
            { id: '6', name: '鹽酥雞', price: 60, icon: '🍖' },
            { id: '7', name: '甜不辣', price: 40, icon: '🍢' },
            { id: '8', name: '肉圓', price: 45, icon: '🥟' },
        ];
        const ICONS = {
            PLUS: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>,
            MINUS: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" /></svg>,
            TRASH: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        };
        
        // --- From services/geminiService.ts ---
        const generateOrderConfirmation = async (orderData) => {
            if (!process.env.API_KEY) {
                console.warn("API_KEY environment variable not set. Returning a mock response.");
                return `✅ 訂單成功！\n訂單編號: MOCK-123\n總金額: $${orderData.totalAmount}\n(注意: 這是一條模擬確認訊息，因為未設定API金鑰)`;
            }
            try {
                // The Gemini library is loaded via script tag and available on `window.google.generativeai`
                const { GoogleGenAI } = window.google.generativeai;
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
                const prompt = `
                  You are an AI assistant for '🍜 台灣小吃店' (Taiwanese Snack Shop).
                  A customer has just submitted an order through our LINE ordering system.
                  Please generate a friendly and slightly humorous order confirmation message in Traditional Chinese (繁體中文).
                  The message should:
                  1. Confirm the order was received.
                  2. Include a unique, fun order number (e.g., "珍奶-123" or "雞排-007").
                  3. Briefly summarize the key details of the order.
                  4. End with a warm closing.

                  Here is the order data in JSON format:
                  ${JSON.stringify(orderData, null, 2)}

                  Generate only the confirmation message text. Keep it concise.
                `;
                const response = await ai.models.generateContent({
                  model: 'gemini-2.5-flash',
                  contents: prompt,
                });
                return response.text;
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return `✅ 訂單已收到，但AI確認訊息產生失敗。\n訂單編號: ERR-456\n總金額: $${orderData.totalAmount}\n我們將手動為您處理。`;
            }
        };
        
        // --- From hooks/useLiff.ts ---
        const useLiff = () => {
            const [liffStatus, setLiffStatus] = useState('initializing');
            const [userProfile, setUserProfile] = useState(null);

            const initializeLiff = useCallback(async () => {
                try {
                    const liff = window.liff;
                    if (!liff) {
                        throw new Error("LIFF SDK not found.");
                    }
                    await liff.init({ liffId: LIFF_ID });

                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        setUserProfile(profile);
                        setLiffStatus('ready');
                    } else {
                        setLiffStatus('logged_out');
                        // Automatically prompt for login if not already logged in.
                        // This will redirect the user, and the page will reload.
                        liff.login();
                    }
                } catch (error) {
                    console.error('LIFF initialization failed', error);
                    setLiffStatus('error');
                }
            }, []);

            useEffect(() => {
                initializeLiff();
            }, [initializeLiff]);

            const sendMessage = useCallback(async (text) => {
                const liff = window.liff;
                if (liff && liff.isInClient()) {
                    try {
                        await liff.sendMessages([{ type: 'text', text }]);
                        return { success: true };
                    } catch (error) {
                        console.error('Failed to send message', error);
                        return { success: false, error };
                    }
                }
                return { success: false, error: 'Not in LINE client' };
            }, []);

            const shareMessage = useCallback(async () => {
                const liff = window.liff;
                if (liff && liff.isInClient() && liff.isApiAvailable('shareTargetPicker')) {
                    try {
                        await liff.shareTargetPicker([
                            {
                                type: 'text',
                                text: '這家台灣小吃超讚的，快來一起點！\nhttps://liff.line.me/' + LIFF_ID,
                            },
                        ]);
                        return { success: true };
                    } catch (error) {
                        console.error('Failed to share message', error);
                        return { success: false, error: error.code === 'USER_CANCEL' ? 'cancelled' : 'error' };
                    }
                }
                return { success: false, error: 'Share API not available or not in LINE client' };
            }, []);

            return { liffStatus, userProfile, sendMessage, shareMessage };
        };

        // --- From hooks/useCart.ts ---
        const useCart = () => {
            const [items, setItems] = useState([]);

            const addToCart = useCallback((menuItem) => {
                setItems((prevItems) => {
                    const existingItem = prevItems.find((item) => item.id === menuItem.id);
                    if (existingItem) {
                        return prevItems.map((item) =>
                            item.id === menuItem.id
                                ? { ...item, quantity: item.quantity + 1 }
                                : item
                        );
                    }
                    return [...prevItems, { ...menuItem, quantity: 1 }];
                });
            }, []);

            const updateQuantity = useCallback((itemId, newQuantity) => {
                if (newQuantity <= 0) {
                    setItems((prevItems) => prevItems.filter((item) => item.id !== itemId));
                } else {
                    setItems((prevItems) =>
                        prevItems.map((item) =>
                            item.id === itemId ? { ...item, quantity: newQuantity } : item
                        )
                    );
                }
            }, []);

            const clearCart = useCallback(() => {
                setItems([]);
            }, []);

            const subtotal = useMemo(() => {
                return items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            }, [items]);

            return { items, addToCart, updateQuantity, clearCart, subtotal };
        };

        // --- From components/Header.tsx ---
        const Header = ({ onBack }) => {
            return (
                <header className="header">
                    {onBack && (
                        <button onClick={onBack} className="back-button" aria-label="返回">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                    )}
                    <h1>🍜 台灣小吃店</h1>
                    <p>LINE 快速訂餐</p>
                    <div className="header-decorator"></div>
                </header>
            );
        };

        // --- From components/LiffStatus.tsx ---
        const LiffStatusDisplay = ({ status, profile }) => {
            const getStatusProps = () => {
                switch (status) {
                    case 'initializing': return { text: '🔄 初始化 LINE 功能中...', type: 'initializing' };
                    case 'ready': return { text: `✅ 歡迎，${profile?.displayName || '用戶'}`, type: 'ready' };
                    case 'logged_out': return { text: '🔄 正在導向 LINE 登入頁面...', type: 'logged_out' };
                    case 'error': return { text: '❌ LINE 功能載入失敗，但仍可訂餐', type: 'error' };
                    default: return { text: '', type: '' };
                }
            };
            const { text, type } = getStatusProps();
            return <div className={`liff-status ${type}`}>{text}</div>;
        };

        // --- From components/OrderForm.tsx ---
        const FormGroup = ({ label, required, children, error }) => (
            <div className="form-group">
                <label>
                    {label}
                    {required && <span className="text-red-500"> *</span>}
                </label>
                {children}
                {error && <p className="error-message">{error}</p>}
            </div>
        );

        const OrderForm = ({ customerName, setCustomerName, customerPhone, setCustomerPhone, pickupTime, setPickupTime, deliveryAddress, setDeliveryAddress, notes, setNotes, phoneError, timeError }) => {
            return (
                <React.Fragment>
                    <FormGroup label="姓名" required>
                        <input type="text" value={customerName} onChange={(e) => setCustomerName(e.target.value)} placeholder="自動帶入 LINE 名稱" />
                    </FormGroup>
                    <FormGroup label="手機號碼" required error={phoneError}>
                        <input type="tel" value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} placeholder="0912345678" className={phoneError ? 'error' : ''} />
                    </FormGroup>
                    <FormGroup label="取餐時間" required error={timeError}>
                        <input type="datetime-local" value={pickupTime} onChange={(e) => setPickupTime(e.target.value)} className={timeError ? 'error' : ''} />
                    </FormGroup>
                    <FormGroup label="外送地點 (選填)">
                        <input type="text" value={deliveryAddress} onChange={(e) => setDeliveryAddress(e.target.value)} placeholder="如需外送請填寫地址" />
                        <p style={{fontSize: '0.75rem', color: '#6b7280', marginTop: '0.25rem', fontStyle: 'italic'}}>※ 填寫地址將自動加收 $30 外送費</p>
                    </FormGroup>
                    <FormGroup label="備註 (選填)">
                        <textarea rows={2} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="例如：不要香菜、加辣、餐具數量等"></textarea>
                    </FormGroup>
                </React.Fragment>
            );
        };
        
        // --- From components/Menu.tsx ---
        const SectionTitle = ({ children }) => (
            <h2 className="section-title">
                {children}
            </h2>
        );
        const Menu = ({ menuItems, onAddToCart }) => {
            const quickAddItems = menuItems.filter(item => ['滷肉飯', '雞肉飯', '珍珠奶茶', '鹽酥雞'].includes(item.name));
            return (
                <div className="menu-container">
                    <SectionTitle>📝 選擇餐點</SectionTitle>
                    <label htmlFor="menuSelect" style={{display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', color: '#374151', fontSize: '0.875rem'}}>從菜單選擇</label>
                    <select id="menuSelect" onChange={(e) => {
                        if (e.target.value) {
                            const selectedItem = menuItems.find(item => item.id === e.target.value);
                            if (selectedItem) onAddToCart(selectedItem);
                            e.target.value = "";
                        }
                    }}>
                        <option value="">-- 請選擇餐點 --</option>
                        {menuItems.map(item => <option key={item.id} value={item.id}>{item.icon} {item.name} - ${item.price}</option>)}
                    </select>
                    <div style={{marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid #e5e7eb'}}>
                        <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', color: '#374151', fontSize: '0.875rem'}}>快速選擇</label>
                        <div className="quick-add-grid">
                            {quickAddItems.map(item => <button key={item.id} type="button" onClick={() => onAddToCart(item)} className="quick-add-btn">{item.icon} {item.name}</button>)}
                        </div>
                    </div>
                </div>
            );
        };

        // --- From components/Cart.tsx ---
        const Cart = ({ items, onUpdateQuantity }) => {
            return (
                <div className="cart-container">
                    <SectionTitle>🛒 訂單明細</SectionTitle>
                    {items.length === 0 ? (
                        <p style={{textAlign: 'center', color: '#6b7280', fontStyle: 'italic', padding: '1rem 0'}}>尚未選擇餐點</p>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                            {items.map(item => (
                                <div key={item.id} className="cart-item">
                                    <div style={{flexGrow: 1}}>
                                        <p style={{fontWeight: 'bold', color: '#1f2937'}}>{item.icon} {item.name}</p>
                                        <p style={{fontSize: '0.875rem', color: '#4b5563'}}>${item.price} x {item.quantity} = ${item.price * item.quantity}</p>
                                    </div>
                                    <div className="quantity-controls">
                                        <button type="button" onClick={() => onUpdateQuantity(item.id, item.quantity - 1)} className="quantity-btn plus-minus-btn">{ICONS.MINUS}</button>
                                        <span className="quantity-display">{item.quantity}</span>
                                        <button type="button" onClick={() => onUpdateQuantity(item.id, item.quantity + 1)} className="quantity-btn plus-minus-btn">{ICONS.PLUS}</button>
                                        <button type="button" onClick={() => onUpdateQuantity(item.id, 0)} className="quantity-btn trash-btn">{ICONS.TRASH}</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- From components/OrderSummary.tsx ---
        const OrderSummary = ({ subtotal, deliveryFee }) => {
            const total = subtotal + deliveryFee;
            return (
                <div className="summary-container">
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '0.25rem', color: '#374151'}}>
                        <span>餐點總計:</span><span>${subtotal}</span>
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem', color: '#374151'}}>
                        <span>外送費:</span><span>${deliveryFee}</span>
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', paddingTop: '0.5rem', borderTop: '1px solid #bbf7d0', fontWeight: 'bold', fontSize: '1.125rem', color: '#1f2937'}}>
                        <span>總金額:</span><span>${total}</span>
                    </div>
                </div>
            );
        };
        
        // --- From components/Footer.tsx ---
        const Footer = () => {
            return (
                <footer className="footer">
                    <p>📍 營業時間: 10:00-21:00</p>
                    <p>📞 聯絡電話: 02-1234-5678</p>
                    <p style={{marginTop: '0.5rem', opacity: 0.7}}>系統版本: 3.2.0 (Auto Login)</p>
                </footer>
            );
        };

        // --- From components/Notification.tsx ---
        const Notification = ({ notification, onClose }) => {
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => onClose(), 6000);
                    return () => clearTimeout(timer);
                }
            }, [notification, onClose]);

            if (!notification) return null;

            return (
                <div className={`notification-toast ${notification.type} ${!notification ? 'hidden' : ''}`}>
                    <p>{notification.type.toUpperCase()}</p>
                    <p>{notification.message}</p>
                </div>
            );
        };
        
        // --- From components/LoadingOverlay.tsx ---
        const LoadingOverlay = ({ isLoading }) => {
            if (!isLoading) return null;
            return (
                <div className="loading-overlay">
                    <div className="spinner"></div>
                    <p className="loading-text">訂單發送中...</p>
                </div>
            );
        };
        
        // --- From components/RichMenuDashboard.tsx ---
        const RICH_MENU_ICONS = {
            ONLINE_ORDER: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.63,16.27V14.14H19.37v2.13c0,1.4-1.12,2.53-2.5,2.53H7.13C5.75,18.8,4.63,17.67,4.63,16.27M19.37,12.7H4.63a3.5,3.5,0,0,1-3.5-3.5,1,1,0,0,1,1-1H21.87a1,1,0,0,1,1,1,3.5,3.5,0,0,1-3.5,3.5Z"/><path d="M7.89,6.5A2.74,2.74,0,0,1,5.63,4.6,2.68,2.68,0,0,1,7.2,2.13a.75.75,0,1,1,.7,1.3,1.21,1.21,0,0,0-.49.88,1.22,1.22,0,0,0,1.21,1.22.75.75,0,0,1,0,1.5,2.71,2.71,0,0,1-1.07-.23Z"/><path d="M12.37,6.5a2.74,2.74,0,0,1-2.26-1.9,2.68,2.68,0,0,1,1.57-2.47.75.75,0,1,1,.7,1.3,1.21,1.21,0,0,0-.49.88,1.22,1.22,0,0,0,1.21,1.22.75.75,0,0,1,0,1.5,2.71,2.71,0,0,1-1.07-.23Z"/><path d="M16.84,6.5a2.74,2.74,0,0,1-2.26-1.9,2.68,2.68,0,0,1,1.57-2.47.75.75,0,1,1,.7,1.3,1.21,1.21,0,0,0-.49.88,1.22,1.22,0,0,0,1.21,1.22.75.75,0,0,1,0,1.5,2.71,2.71,0,0,1-1.07-.23Z"/></svg>,
            VIEW_MENU: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8Zm2,16H8V16h8Zm0-4H8V12h8Zm-2-6V4.5L18.5,9Z"/></svg>,
            CONTACT: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1,0,0,1,21,16.5V20a1,1,0,0,1-1,1C10.21,21 3,13.79 3,4A1,1,0,0,1,4,3H7.5A1,1,0,0,1,8.5,4c0,1.25,0.2,2.45,0.57,3.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/></svg>,
            ORDER_INQUIRY: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.5,3A6.5,6.5,0,0,1,16,9.5c0,1.61-.59,3.09-1.57,4.23l.27.27h.79l5,5-1.5,1.5-5-5v-.79l-.27-.27A6.5,6.5,0,0,1,9.5,16,6.5,6.5,0,0,1,3,9.5,6.5,6.5,0,0,1,9.5,3M9.5,5C7,5,5,7,5,9.5S7,14,9.5,14,14,12,14,9.5,12,5,9.5,5Z"/></svg>,
            LOCATION: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,11.5A2.5,2.5,0,0,1,9.5,9A2.5,2.5,0,0,1,12,6.5A2.5,2.5,0,0,1,14.5,9A2.5,2.5,0,0,1,12,11.5M12,2A7,7,0,0,0,5,9c0,5.25,7,13,7,13s7-7.75,7-13A7,7,0,0,0,12,2Z"/></svg>,
            PROMOTIONS: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20,2H4C2.9,2,2,2.9,2,4v16c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2V4C22,2.9,21.1,2,20,2z M10.4,15.5L8,12.7l1.4-1.4l1,1l3.6-4.2l1.4,1.4L10.4,15.5z"/></svg>,
        };
        const MenuButton = ({ icon, label, onClick, bgColorClass }) => (
            <button onClick={onClick} className={`menu-button ${bgColorClass}`}>
                {icon}
                <span>{label}</span>
            </button>
        );
        const RichMenuDashboard = ({ onNavigateToOrder, liffHook, showNotification }) => {
            const { liffStatus, userProfile } = liffHook;

            const handleViewMenu = onNavigateToOrder;
            const handleContactSupport = () => alert('📞 聯絡客服請撥打: 02-1234-5678');
            const handleOrderInquiry = () => showNotification({ type: 'warning', message: '訂單查詢功能即將推出，敬請期待！' });
            const handleLocationInfo = () => alert('📍 本店地址：\n台北市信義區市府路45號\n\n🕒 營業時間: 10:00-21:00');
            const handlePromotions = () => showNotification({ type: 'success', message: '目前沒有特別的優惠活動，但我們的滷肉飯天天都好吃！' });

            return (
                <div className="screen">
                    <Header />
                    <main className="screen-main">
                        <LiffStatusDisplay status={liffStatus} profile={userProfile} />
                        <div className="rich-menu-grid">
                            <MenuButton icon={RICH_MENU_ICONS.ONLINE_ORDER} label="線上訂餐" onClick={onNavigateToOrder} bgColorClass="bg-green-600" />
                            <MenuButton icon={RICH_MENU_ICONS.VIEW_MENU} label="查看菜單" onClick={handleViewMenu} bgColorClass="bg-blue-500" />
                            <MenuButton icon={RICH_MENU_ICONS.CONTACT} label="聯絡客服" onClick={handleContactSupport} bgColorClass="bg-orange-500" />
                            <MenuButton icon={RICH_MENU_ICONS.ORDER_INQUIRY} label="訂單查詢" onClick={handleOrderInquiry} bgColorClass="bg-purple-500" />
                            <MenuButton icon={RICH_MENU_ICONS.LOCATION} label="位置資訊" onClick={handleLocationInfo} bgColorClass="bg-red-600" />
                            <MenuButton icon={RICH_MENU_ICONS.PROMOTIONS} label="優惠活動" onClick={handlePromotions} bgColorClass="bg-yellow-600" />
                        </div>
                    </main>
                    <Footer />
                </div>
            );
        };

        // --- From components/OrderScreen.tsx ---
        const OrderScreen = ({ onBack, liffHook, showNotification }) => {
            const { liffStatus, userProfile, sendMessage } = liffHook;
            const { items: cartItems, addToCart, updateQuantity, clearCart, subtotal } = useCart();
            
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [pickupTime, setPickupTime] = useState('');
            const [deliveryAddress, setDeliveryAddress] = useState('');
            const [notes, setNotes] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [phoneError, setPhoneError] = useState('');
            const [timeError, setTimeError] = useState('');

            const deliveryFee = deliveryAddress.trim() ? DELIVERY_FEE : 0;
            const isOrderSubmittable = cartItems.length > 0;

            const setDefaultPickupTime = useCallback(() => {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 30);
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                setPickupTime(`${year}-${month}-${day}T${hours}:${minutes}`);
            }, []);

            useEffect(() => { setDefaultPickupTime(); }, [setDefaultPickupTime]);
            useEffect(() => { if (userProfile?.displayName) { setCustomerName(userProfile.displayName); } }, [userProfile]);
            
            const handleAddToCart = (item) => {
                addToCart(item);
                showNotification({ type: 'success', message: `已添加 ${item.name}` });
            };

            const validateForm = () => {
                let isValid = true;
                if (!/^09\d{8}$/.test(customerPhone)) { setPhoneError('請輸入正確的手機號碼 (09開頭，10位數字)'); isValid = false; } else { setPhoneError(''); }
                if (!pickupTime) { setTimeError('請選擇取餐時間'); isValid = false; }
                else if (new Date(pickupTime) < new Date()) { setTimeError('取餐時間不能是過去的時間'); isValid = false; }
                else { setTimeError(''); }
                if (cartItems.length === 0) { showNotification({ type: 'error', message: '請選擇至少一樣餐點' }); isValid = false; }
                if (!customerName.trim()) { showNotification({ type: 'error', message: '請輸入您的姓名' }); isValid = false; }
                return isValid;
            };
            
            const resetForm = useCallback(() => {
                clearCart(); setCustomerPhone(''); setDeliveryAddress(''); setNotes(''); setPhoneError(''); setTimeError('');
                if (userProfile?.displayName) { setCustomerName(userProfile.displayName); }
                setDefaultPickupTime();
            }, [clearCart, setDefaultPickupTime, userProfile]);

            const handleOrderSubmit = async () => {
                if (!validateForm()) return;
                setIsLoading(true);
                
                const orderData = {
                    customerName: customerName,
                    customerPhone: customerPhone,
                    customerLineUserId: userProfile?.userId || '未綁定',
                    items: cartItems,
                    totalAmount: subtotal + deliveryFee,
                    pickupTime: new Date(pickupTime).toLocaleString('zh-TW'),
                    deliveryAddress: deliveryAddress || '無',
                    notes: notes || '無',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const confirmationMessage = await generateOrderConfirmation(orderData);
                    showNotification({ type: 'success', message: confirmationMessage });
                    if (liffStatus === 'ready') {
                        const liffMessage = `感謝您的訂購！\n訂單摘要：\n${cartItems.map(item => `${item.name} x${item.quantity}`).join('\n')}\n總金額: $${orderData.totalAmount}\n取餐時間: ${orderData.pickupTime}\n\n${confirmationMessage.split('\n')[0]}`;
                        await sendMessage(liffMessage);
                    }
                    resetForm();
                    onBack();
                } catch (error) {
                    showNotification({ type: 'error', message: `訂單發送失敗，請稍後再試。\n${error instanceof Error ? error.message : String(error)}` });
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="screen">
                    <LoadingOverlay isLoading={isLoading} />
                    <Header onBack={onBack}/>
                    <main className="screen-main">
                        <LiffStatusDisplay status={liffStatus} profile={userProfile} />
                        <OrderForm {...{ customerName, setCustomerName, customerPhone, setCustomerPhone, pickupTime, setPickupTime, deliveryAddress, setDeliveryAddress, notes, setNotes, phoneError, timeError }}/>
                        <Menu menuItems={MENU_ITEMS} onAddToCart={handleAddToCart} />
                        <Cart items={cartItems} onUpdateQuantity={updateQuantity} />
                        <OrderSummary subtotal={subtotal} deliveryFee={deliveryFee} />
                        <button onClick={handleOrderSubmit} disabled={!isOrderSubmittable || isLoading} className="submit-btn">✅ 送出訂單</button>
                    </main>
                    <Footer />
                </div>
            );
        };
        
        // --- From App.tsx ---
        const App = () => {
            const [view, setView] = useState('menu');
            const [notification, setNotification] = useState(null);
            const liffHook = useLiff();

            const showNotification = (notification) => setNotification(notification);

            return (
                <div className="app-container">
                    <Notification notification={notification} onClose={() => setNotification(null)} />
                    {view === 'menu' ? (
                        <RichMenuDashboard onNavigateToOrder={() => setView('order')} liffHook={liffHook} showNotification={showNotification}/>
                    ) : (
                        <OrderScreen onBack={() => setView('menu')} liffHook={liffHook} showNotification={showNotification} />
                    )}
                </div>
            );
        };
        
        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        const root = createRoot(rootElement);
        root.render(
            <StrictMode>
                <App />
            </StrictMode>
        );
    })();
    </script>
</body>
</html>
