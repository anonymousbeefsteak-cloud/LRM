<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣小吃店 - LINE訂餐系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary: #16a34a;
            --primary-dark: #15803d;
            --danger: #ef4444;
            --gray: #6b7280;
            --border: #e5e7eb;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: linear-gradient(to bottom right, #f0fdf4, #eff6ff); min-height: 100vh; padding: 24px 12px; }
        .container { max-width: 28rem; margin: auto; background: white; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        .header h1 { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .header p { opacity: 0.9; font-size: 0.875rem; margin: 4px 0 0; }
        .main { padding: 20px; }
        .footer { text-align: center; padding: 1rem; color: var(--gray); font-size: 0.75rem; border-top: 1px solid var(--border); background: #f9fafb; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
        .section-title { font-size: 1.125rem; font-weight: bold; text-align: center; color: #1f2937; margin-bottom: 24px; position: relative; }
        .section-title::after { content: ''; position: absolute; bottom: -8px; left: 25%; right: 25%; height: 2px; background: var(--primary); }
        .liff-status { padding: 0.75rem; margin-bottom: 1rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: center; border: 1px solid; }
        .liff-status.initializing { background: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; }
        .liff-status.ready { background: #dcfce7; border-color: #4ade80; color: #166534; }
        .liff-status.logged_out { background: #fefce8; border-color: #facc15; color: #854d0e; }
        .liff-status.error { background: #fee2e2; border-color: #f87171; color: #991b1b; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151; font-size: 0.875rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5); }
        .form-group.error input, .form-group.error textarea { border-color: var(--danger); }
        .error-message { color: var(--danger); font-size: 0.75rem; margin-top: 0.25rem; }
        .menu-container, .cart-container, .summary-container { padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); margin: 1rem 0; }
        .menu-container { background: #f9fafb; }
        .cart-container { background: #fefce8; border-color: #fde68a; }
        .summary-container { background: #f0fdf4; border-color: #bbf7d0; }
        .quick-add-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        @media (min-width: 640px) { .quick-add-grid { grid-template-columns: repeat(4, 1fr); } }
        .quick-add-btn { padding: 0.5rem; border: 1px solid var(--primary); color: #166534; border-radius: 0.375rem; font-size: 0.875rem; }
        .quick-add-btn:hover { background: var(--primary); color: white; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #fde68a; }
        .cart-item:last-child { border-bottom: none; }
        .quantity-controls { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-btn, .remove-btn { width: 1.75rem; height: 1.75rem; display: flex; align-items: center; justify-content: center; border-radius: 9999px; color: white; }
        .quantity-btn { background: var(--primary); }
        .quantity-btn:hover { background: var(--primary-dark); transform: scale(1.1); }
        .remove-btn { background: var(--danger); margin-left: 0.5rem; }
        .remove-btn:hover { background: #dc2626; transform: scale(1.1); }
        .quantity-display { width: 1.5rem; text-align: center; font-weight: bold; }
        .submit-btn { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 0.5rem; font-weight: bold; font-size: 1.125rem; }
        .submit-btn:hover:not(:disabled) { background: var(--primary-dark); transform: scale(1.05); }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .notification { position: fixed; top: 1.25rem; right: 1.25rem; max-width: 24rem; padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .notification.success { background: var(--primary); }
        .notification.error { background: var(--danger); }
        .notification.info { background: #3b82f6; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 4rem; height: 4rem; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 1rem; font-size: 1.125rem; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .status-online { background: #22c55e; }
        .status-offline { background: #f87171; }
        .liff-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center; }
        .liff-btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; }
        .liff-btn.primary { background: var(--primary); color: white; }
        .liff-btn.primary:hover { background: var(--primary-dark); }
        .liff-btn.secondary { background: #6b7280; color: white; }
        .liff-btn.secondary:hover { background: #4b5563; }
        .notification-status { padding: 0.5rem; margin-top: 0.5rem; border-radius: 0.375rem; }
        .notification-status.success { background: #dcfce7; color: #166534; }
        .notification-status.error { background: #fee2e2; color: #991b1b; }
        #lineGuide { margin-bottom: 1rem; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>🍜 台灣小吃店</h1>
            <p>LINE 快速訂餐</p>
        </header>
        <main class="main">
            <div id="liffStatus" class="liff-status initializing">
                <span class="status-indicator status-offline"></span> 正在初始化 LINE 功能...
            </div>
            <div id="lineGuide" style="display: none;">
                <h3><i class="fab fa-line"></i> 請在 LINE App 中開啟</h3>
                <p>開啟 LINE 以獲得完整功能</p>
                <div class="liff-actions">
                    <button class="liff-btn primary" onclick="openInLineApp()">
                        <i class="fas fa-sign-in-alt"></i> 在 LINE 中開啟
                    </button>
                    <button class="liff-btn secondary" onclick="enableBasicMode()">
                        <i class="fas fa-shopping-cart"></i> 繼續訂餐
                    </button>
                </div>
            </div>
            <div id="userInfo" style="display: none;"></div>
            <div class="form-group">
                <label>姓名 <span style="color: var(--danger);">*</span></label>
                <input id="customerName" type="text" placeholder="自動帶入 LINE 名稱">
            </div>
            <div class="form-group" id="phoneGroup">
                <label>手機號碼 <span style="color: var(--danger);">*</span></label>
                <input id="customerPhone" type="tel" placeholder="0912345678">
                <p id="phoneError" class="error-message" style="display: none;">請輸入正確的手機號碼 (09開頭，10位數字)</p>
            </div>
            <div class="form-group" id="timeGroup">
                <label>取餐時間 <span style="color: var(--danger);">*</span></label>
                <input id="pickupTime" type="datetime-local">
                <p id="timeError" class="error-message" style="display: none;">請選擇取餐時間</p>
            </div>
            <div class="form-group">
                <label>外送地點 (選填)</label>
                <input id="deliveryAddress" type="text" placeholder="如需外送請填寫地址">
                <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem; font-style: italic;">※ 填寫地址將自動加收 $30 外送費</p>
            </div>
            <div class="form-group">
                <label>備註 (選填)</label>
                <textarea id="notes" rows="2" placeholder="例如：不要香菜、加辣、餐具數量等"></textarea>
            </div>
            <div class="menu-container">
                <h2 class="section-title">📝 選擇餐點</h2>
                <label>從菜單選擇</label>
                <select id="menuSelect">
                    <option value="">-- 請選擇餐點 --</option>
                    <option value="滷肉飯">🍚 滷肉飯 - $35</option>
                    <option value="雞肉飯">🍗 雞肉飯 - $40</option>
                    <option value="蚵仔煎">🍳 蚵仔煎 - $65</option>
                    <option value="大腸麵線">🍜 大腸麵線 - $50</option>
                    <option value="珍珠奶茶">🥤 珍珠奶茶 - $45</option>
                    <option value="鹽酥雞">🍖 鹽酥雞 - $60</option>
                    <option value="甜不辣">🍢 甜不辣 - $40</option>
                    <option value="肉圓">🥟 肉圓 - $45</option>
                </select>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <label>快速選擇</label>
                    <div class="quick-add-grid">
                        <button type="button" class="quick-add-btn" onclick="quickAdd('滷肉飯')">🍚 滷肉飯</button>
                        <button type="button" class="quick-add-btn" onclick="quickAdd('雞肉飯')">🍗 雞肉飯</button>
                        <button type="button" class="quick-add-btn" onclick="quickAdd('珍珠奶茶')">🥤 珍珠奶茶</button>
                        <button type="button" class="quick-add-btn" onclick="quickAdd('鹽酥雞')">🍖 鹽酥雞</button>
                    </div>
                </div>
            </div>
            <div class="cart-container">
                <h2 class="section-title">🛒 訂單明細</h2>
                <div id="cartItems">
                    <div class="empty-cart">尚未選擇餐點</div>
                </div>
            </div>
            <div class="summary-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span>餐點總計:</span><span id="subtotal">$0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>外送費:</span><span id="deliveryFee">$0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #bbf7d0; font-weight: bold; font-size: 1.125rem;">
                    <span>總金額:</span><span id="totalAmount">$0</span>
                </div>
                <div id="notificationStatus"></div>
            </div>
            <button id="submitBtn" class="submit-btn" onclick="submitOrder()" disabled>✅ 送出訂單</button>
            <div id="loading" class="loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <p class="loading-text">訂單發送中...</p>
            </div>
            <div id="notification" class="notification" style="display: none;"></div>
        </main>
        <footer class="footer">
            <p>📍 營業時間: 10:00-21:00</p>
            <p>📞 聯絡電話: 02-1234-5678</p>
            <p style="margin-top: 0.5rem; opacity: 0.7;">系統版本: 1.0.0</p>
        </footer>
    </div>
    <script>
        // 系統配置
        const CONFIG = {
            LIFF_ID: '2008316489-6nMjb0KX',
            API_ENDPOINT: '你的 Google Apps Script Web App URL'
        };

        // 菜單價格
        const menuPrices = {
            '滷肉飯': 35,
            '雞肉飯': 40,
            '蚵仔煎': 65,
            '大腸麵線': 50,
            '珍珠奶茶': 45,
            '鹽酥雞': 60,
            '甜不辣': 40,
            '肉圓': 45
        };

        // 餐點圖示
        const menuIcons = {
            '滷肉飯': '🍚',
            '雞肉飯': '🍗',
            '蚵仔煎': '🍳',
            '大腸麵線': '🍜',
            '珍珠奶茶': '🥤',
            '鹽酥雞': '🍖',
            '甜不辣': '🍢',
            '肉圓': '🥟'
        };

        let cart = [];
        let userProfile = null;
        let isLineMode = false;
        let isBasicMode = false;

        // 在 LINE App 中開啟
        function openInLineApp() {
            const lineUrl = `https://line.me/R/app/${CONFIG.LIFF_ID}`;
            window.open(lineUrl, '_blank');
            showNotification('請在 LINE App 中開啟連結', 'info', 4000);
        }

        // 啟用基本模式
        function enableBasicMode() {
            isBasicMode = true;
            document.getElementById('lineGuide').style.display = 'none';
            document.getElementById('liffStatus').innerHTML = 
                '<span class="status-indicator status-offline"></span> 基本訂餐模式<br><small style="color: var(--gray);">部分功能受限</small>';
            showNotification('已啟用基本訂餐模式', 'info', 3000);
        }

        // 初始化 LIFF
        async function initializeLiff() {
            try {
                const isInLine = navigator.userAgent.includes('Line') || 
                                window.location.href.includes('liff.state') ||
                                document.referrer.includes('line.me');
                
                if (!isInLine) {
                    document.getElementById('liffStatus').innerHTML = 
                        '<span class="status-indicator status-offline"></span> 請在 LINE App 中開啟以獲得完整功能';
                    document.getElementById('lineGuide').style.display = 'block';
                    return;
                }

                document.getElementById('liffStatus').innerHTML = 
                    '<span class="status-indicator status-offline"></span> 正在初始化 LINE 功能...';
                
                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (liff.isLoggedIn()) {
                    userProfile = await liff.getProfile();
                    isLineMode = true;
                    document.getElementById('customerName').value = userProfile.displayName;
                    document.getElementById('userInfo').innerHTML = `
                        <span class="status-indicator status-online"></span> 
                        LINE 帳號已綁定<br>
                        👋 歡迎，${userProfile.displayName}
                    `;
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('liffStatus').innerHTML = 
                        '<span class="status-indicator status-online"></span> LINE 模式已就緒';
                    document.getElementById('lineGuide').style.display = 'none';
                    liff.sendMessages([{type: 'text', text: '歡迎使用訂餐系統！'}]);
                } else {
                    document.getElementById('liffStatus').innerHTML = 
                        '<span class="status-indicator status-offline"></span> 請登入 LINE 帳號';
                    document.getElementById('lineGuide').innerHTML = `
                        <h3><i class="fab fa-line"></i> 請登入 LINE 帳號</h3>
                        <p>登入後可自動填寫姓名並接收訂單通知</p>
                        <div class="liff-actions">
                            <button class="liff-btn primary" onclick="liff.login()">
                                <i class="fas fa-sign-in-alt"></i> 登入 LINE
                            </button>
                            <button class="liff-btn secondary" onclick="enableBasicMode()">
                                <i class="fas fa-shopping-cart"></i> 繼續訂餐
                            </button>
                        </div>
                    `;
                    document.getElementById('lineGuide').style.display = 'block';
                }
            } catch (error) {
                console.error('LIFF 初始化失敗:', error);
                let errorMessage = 'LINE 功能載入失敗';
                if (error.message.includes('LIFF_ID')) {
                    errorMessage = 'LIFF 設定錯誤，請聯絡店家';
                } else if (error.message.includes('invalid id')) {
                    errorMessage = '無效的 LIFF ID';
                } else if (error.message.includes('Network Error')) {
                    errorMessage = '網路連線失敗，請檢查網路';
                }
                document.getElementById('liffStatus').innerHTML = 
                    `<span class="status-indicator status-offline"></span> ${errorMessage}`;
                document.getElementById('lineGuide').style.display = 'block';
            }
        }

        // 修復的 API 調用函數
        function submitOrderViaGet(orderData) {
            return new Promise((resolve, reject) => {
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'createOrder');
                    params.append('data', JSON.stringify(orderData));
                    const url = `${CONFIG.API_ENDPOINT}?${params.toString()}`;
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(result => resolve(result))
                        .catch(error => reject(error));
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 快速添加餐點
        function quickAdd(itemName) {
            const existingItem = cart.find(item => item.name === itemName);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    name: itemName,
                    price: menuPrices[itemName],
                    quantity: 1
                });
            }
            renderCart();
            updateOrderSummary();
            showNotification(`已添加 ${itemName}`, 'success', 2000);
        }

        // 添加到購物車
        function addToCart() {
            const menuSelect = document.getElementById('menuSelect');
            const selectedItem = menuSelect.value;
            if (!selectedItem) return;
            const existingItem = cart.find(item => item.name === selectedItem);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    name: selectedItem,
                    price: menuPrices[selectedItem],
                    quantity: 1
                });
            }
            menuSelect.value = '';
            renderCart();
            updateOrderSummary();
            showNotification(`已添加 ${selectedItem}`, 'success', 2000);
        }

        // 渲染購物車
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart">尚未選擇餐點</div>';
                return;
            }
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <strong>${menuIcons[item.name]} ${item.name}</strong>
                        <div style="font-size: 13px; color: var(--gray);">
                            $${item.price} x ${item.quantity} = $${item.price * item.quantity}
                        </div>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="adjustQuantity('${item.name}', -1)">-</button>
                        <span class="quantity-display">${item.quantity}</span>
                        <button class="quantity-btn" onclick="adjustQuantity('${item.name}', 1)">+</button>
                        <button class="remove-btn" onclick="removeItem('${item.name}')">刪除</button>
                    </div>
                </div>
            `).join('');
        }

        // 調整數量
        function adjustQuantity(itemName, change) {
            const item = cart.find(item => item.name === itemName);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeItem(itemName);
                } else {
                    renderCart();
                    updateOrderSummary();
                }
            }
        }

        // 移除項目
        function removeItem(itemName) {
            cart = cart.filter(item => item.name !== itemName);
            renderCart();
            updateOrderSummary();
            showNotification(`已移除 ${itemName}`, 'success', 2000);
        }

        // 更新訂單總計
        function updateOrderSummary() {
            let subtotal = 0;
            cart.forEach(item => {
                subspace += item.price * item.quantity;
            });
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const deliveryFee = deliveryAddress ? 30 : 0;
            const total = subtotal + deliveryFee;
            document.getElementById('subtotal').textContent = `$${subtotal}`;
            document.getElementById('deliveryFee').textContent = `$${deliveryFee}`;
            document.getElementById('totalAmount').textContent = `$${total}`;
            document.getElementById('submitBtn').disabled = cart.length === 0;
        }

        // 驗證表單
        function validateForm() {
            let isValid = true;
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                document.getElementById('customerName').style.borderColor = 'var(--danger)';
                isValid = false;
            } else {
                document.getElementById('customerName').style.borderColor = '';
            }
            const phone = document.getElementById('customerPhone').value.trim();
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone)) {
                document.getElementById('phoneGroup').classList.add('error');
                document.getElementById('phoneError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('phoneGroup').classList.remove('error');
                document.getElementById('phoneError').style.display = 'none';
            }
            const pickupTime = document.getElementById('pickupTime').value;
            if (!pickupTime) {
                document.getElementById('timeGroup').classList.add('error');
                document.getElementById('timeError').style.display = 'block';
                isValid = false;
            } else if (new Date(pickupTime) < new Date()) {
                document.getElementById('timeGroup').classList.add('error');
                document.getElementById('timeError').textContent = '取餐時間不能是過去時間';
                document.getElementById('timeError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('timeGroup').classList.remove('error');
                document.getElementById('timeError').style.display = 'none';
            }
            if (cart.length === 0) {
                showNotification('請選擇至少一樣餐點', 'error', 3000);
                isValid = false;
            }
            return isValid;
        }

        // 顯示通知
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // 設定載入狀態
        function setLoading(loading) {
            const loadingElement = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');
            if (loading) {
                loadingElement.style.display = 'flex';
                submitBtn.style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
                submitBtn.style.display = 'block';
            }
        }

        // 顯示通知狀態
        function showNotificationStatus(storeResult, customerResult) {
            const statusContainer = document.getElementById('notificationStatus');
            let statusHtml = '';
            if (storeResult && storeResult.success) {
                statusHtml += '<div class="notification-status success">✅ 店家已收到訂單通知</div>';
            } else {
                statusHtml += `<div class="notification-status error">⚠️ 店家通知: ${storeResult?.message || '發送失敗'}</div>`;
            }
            if (customerResult && customerResult.success) {
                statusHtml += '<div class="notification-status success">✅ 已發送 LINE 通知給您</div>';
            } else if (isLineMode) {
                statusHtml += `<div class="notification-status error">⚠️ 客戶通知: ${customerResult?.message || '未發送'}</div>`;
            }
            statusContainer.innerHTML = statusHtml;
        }

        // 提交訂單
        async function submitOrder() {
            if (!validateForm()) return;
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const pickupTime = document.getElementById('pickupTime').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const notes = document.getElementById('notes').value.trim();
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryFee = deliveryAddress ? 30 : 0;
            const finalTotal = totalAmount + deliveryFee;
            const orderData = {
                customerName,
                customerPhone,
                customerLineUserId: isLineMode ? (userProfile?.userId || 'LINE_USER') : 'WEB_USER',
                items: cart,
                totalAmount: finalTotal,
                pickupTime,
                deliveryAddress,
                notes,
                timestamp: new Date().toISOString(),
                source: isLineMode ? 'LINE' : (isBasicMode ? 'BASIC' : 'WEB')
            };
            setLoading(true);
            try {
                const result = await submitOrderViaGet(orderData);
                if (result.success) {
                    const orderId = result.data?.orderId || 'N/A';
                    if (result.data.notifications) {
                        showNotificationStatus(result.data.notifications.store, result.data.notifications.customer);
                    }
                    let successMessage = `✅ 訂單成功！\n訂單編號: ${orderId}\n總金額: $${finalTotal}`;
                    if (isLineMode) {
                        successMessage += '\n📱 已發送訂單確認通知';
                    } else {
                        successMessage += '\n📞 店家將電話確認訂單';
                    }
                    showNotification(successMessage, 'success', 6000);
                    resetOrder();
                } else {
                    throw new Error(result.message || '訂單處理失敗');
                }
            } catch (error) {
                let errorMessage = `❌ 發送失敗\n${error.message}`;
                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                    errorMessage += '\n\n請檢查網路連線';
                }
                showNotification(errorMessage, 'error', 8000);
            } finally {
                setLoading(false);
            }
        }

        // 設定預設取餐時間
        function setDefaultPickupTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('pickupTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            const minDate = new Date();
            minDate.setMinutes(minDate.getMinutes() - 10);
            document.getElementById('pickupTime').min = minDate.toISOString().slice(0, 16);
        }

        // 重置訂單
        function resetOrder() {
            cart = [];
            renderCart();
            document.getElementById('customerPhone').value = '';
            document.getElementById('deliveryAddress').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('phoneGroup').classList.remove('error');
            document.getElementById('timeGroup').classList.remove('error');
            document.getElementById('phoneError').style.display = 'none';
            document.getElementById('timeError').style.display = 'none';
            document.getElementById('notificationStatus').innerHTML = '';
            setDefaultPickupTime();
            updateOrderSummary();
            if (!userProfile) {
                document.getElementById('customerName').value = '';
            }
        }

        // 初始化事件監聽
        function initializeEventListeners() {
            document.getElementById('deliveryAddress').addEventListener('input', updateOrderSummary);
            document.getElementById('menuSelect').addEventListener('change', addToCart);
            document.getElementById('customerPhone').addEventListener('input', function() {
                const phone = this.value.trim();
                const phoneRegex = /^09\d{8}$/;
                if (phone && !phoneRegex.test(phone)) {
                    document.getElementById('phoneGroup').classList.add('error');
                    document.getElementById('phoneError').style.display = 'block';
                } else {
                    document.getElementById('phoneGroup').classList.remove('error');
                    document.getElementById('phoneError').style.display = 'none';
                }
            });
            document.getElementById('pickupTime').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('timeGroup').classList.remove('error');
                    document.getElementById('timeError').style.display = 'none';
                    if (new Date(this.value) < new Date()) {
                        document.getElementById('timeGroup').classList.add('error');
                        document.getElementById('timeError').textContent = '取餐時間不能是過去時間';
                        document.getElementById('timeError').style.display = 'block';
                    }
                }
            });
            setInterval(() => {
                document.getElementById('submitBtn').disabled = cart.length === 0;
            }, 1000);
        }

        // 頁面載入初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            setDefaultPickupTime();
            initializeLiff();
        });
    </script>
</body>
</html>
