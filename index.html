
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°ç£å°åƒåº— - LINEè¨‚é¤ç³»çµ±</title>
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <style>
        /* General Reset & Body Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #f0fdf4, #eff6ff);
            min-height: 100vh;
            padding: 24px 12px;
            box-sizing: border-box;
        }
        #root {
            height: 100%;
        }

        /* Main App Container */
        .app-container {
            max-width: 28rem;
            margin: auto;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            position: relative;
        }

        .screen {
            display: flex;
            flex-direction: column;
            min-height: 100dvh;
        }

        .screen-main {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* Header */
        .header {
            background-color: #16a34a; /* bg-green-600 */
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }
        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }
        .header-decorator {
            position: absolute;
            bottom: 0;
            left: 25%;
            right: 25%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 9999px;
        }
        .back-button {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            padding: 8px;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .back-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 1rem;
            color: #6b7280;
            font-size: 0.75rem;
            border-top: 1px solid #e5e7eb;
            background-color: #f9fafb;
            border-bottom-left-radius: 0.75rem;
            border-bottom-right-radius: 0.75rem;
        }

        /* Section Title */
        .section-title {
            font-size: 1.125rem;
            font-weight: bold;
            text-align: center;
            color: #1f2937;
            margin-bottom: 24px;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 25%;
            right: 25%;
            height: 2px;
            background-color: #22c55e;
        }
        
        /* Form Group & Inputs */
        .form-group { margin-bottom: 1rem; }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #374151;
            font-size: 0.875rem;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: box-shadow 0.2s, border-color 0.2s;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5);
        }
        .form-group input.error, .form-group textarea.error {
            border-color: #ef4444;
        }
        .form-group input.error:focus, .form-group textarea.error:focus {
            border-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.5);
        }
        .error-message { color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem; }

        /* LIFF Status */
        .liff-status {
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            text-align: center;
            border-width: 1px;
        }
        .liff-status.initializing { background-color: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; }
        .liff-status.ready { background-color: #dcfce7; border-color: #4ade80; color: #166534; }
        .liff-status.logged_out { background-color: #fefce8; border-color: #facc15; color: #854d0e; }
        .liff-status.error { background-color: #fee2e2; border-color: #f87171; color: #991b1b; }

        /* Rich Menu Dashboard */
        .rich-menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        .menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            border-radius: 0.75rem;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: transform 0.2s, box-shadow 0.2s;
            background-image: linear-gradient(rgba(255, 255, 255, 0.07), rgba(0, 0, 0, 0.07));
            border: none;
            cursor: pointer;
        }
        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .menu-button svg {
            width: 2.25rem;
            height: 2.25rem;
        }
        .menu-button span {
            margin-top: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .bg-green-600 { background-color: #16a34a; } .bg-green-600:hover { background-color: #15803d; }
        .bg-blue-500 { background-color: #3b82f6; } .bg-blue-500:hover { background-color: #2563eb; }
        .bg-orange-500 { background-color: #f97316; } .bg-orange-500:hover { background-color: #ea580c; }
        .bg-purple-500 { background-color: #8b5cf6; } .bg-purple-500:hover { background-color: #7c3aed; }
        .bg-red-600 { background-color: #c53030; } .bg-red-600:hover { background-color: #a02828; }
        .bg-yellow-600 { background-color: #d69e2e; } .bg-yellow-600:hover { background-color: #b08225; }

        /* Menu Section */
        .menu-container {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            margin: 1rem 0;
        }
        .quick-add-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .quick-add-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .quick-add-btn {
            width: 100%;
            text-align: left;
            padding: 0.5rem;
            border: 1px solid #22c55e;
            color: #166534;
            border-radius: 0.375rem;
            transition: background-color 0.2s, color 0.2s;
            font-size: 0.875rem;
        }
        .quick-add-btn:hover { background-color: #22c55e; color: white; }

        /* Cart Section */
        .cart-container {
            background-color: #fefce8;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fde68a;
            margin: 1rem 0;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #fde68a;
        }
        .cart-item:last-child { border-bottom: none; }
        .quantity-controls { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-btn {
            width: 1.75rem; height: 1.75rem; display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; color: white; transition: transform 0.2s, background-color 0.2s;
        }
        .quantity-btn:hover { transform: scale(1.1); }
        .quantity-btn svg { width: 1rem; height: 1rem; }
        .plus-minus-btn { background-color: #22c55e; } .plus-minus-btn:hover { background-color: #16a34a; }
        .trash-btn { background-color: #ef4444; margin-left: 0.5rem; } .trash-btn:hover { background-color: #dc2626; }
        .quantity-display { width: 1.5rem; text-align: center; font-weight: bold; }

        /* Order Summary */
        .summary-container {
            background-color: #f0fdf4; padding: 1rem; border-radius: 0.5rem;
            border: 1px solid #bbf7d0; margin: 1rem 0; font-size: 0.875rem;
        }

        /* Submit Button */
        .submit-btn {
            width: 100%; margin-top: 1rem; padding: 1rem; background-color: #16a34a; color: white;
            border-radius: 0.5rem; font-weight: bold; font-size: 1.125rem;
            transition: all 0.3s;
        }
        .submit-btn:hover { background-color: #15803d; }
        .submit-btn:disabled {
            background-color: #9ca3af; cursor: not-allowed;
            transform: none;
        }
        .submit-btn:hover:not(:disabled) { transform: scale(1.05); }

        /* Loading Overlay */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50;
        }
        .spinner {
            width: 4rem; height: 4rem; border: 4px solid #e5e7eb;
            border-top-color: #22c55e; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text { color: white; margin-top: 1rem; font-size: 1.125rem; }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed; top: 1.25rem; right: 1.25rem; width: 91.666667%; max-width: 24rem;
            padding: 1rem; border-radius: 0.5rem; color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateX(0);
            transition: transform 0.3s ease-in-out;
        }
        .notification-toast.hidden { transform: translateX(110%); }
        .notification-toast.success { background-color: #22c55e; }
        .notification-toast.error { background-color: #ef4444; }
        .notification-toast.warning { background-color: #f59e0b; }
        .notification-toast p:first-child { font-weight: bold; }
        .notification-toast p:last-child { font-size: 0.875rem; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    (function() {
        const { useState, useEffect, useCallback, useMemo, StrictMode } = React;
        const { createRoot } = ReactDOM;

        // --- From constants.tsx ---
        const LIFF_ID = '2008316489-6nMjb0KX';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxec_ZhXtYbPLG2Xc7Qv1-E1fIAwQPfBvSZ6KaD44kQsEzc7DcQFBvhUBxwSJXNf1_Q/exec';
        const DELIVERY_FEE = 30;
        
        // Fallback menu in case fetching from Google Sheets fails
        const FALLBACK_MENU_ITEMS = [
            { id: '1', name: 'æ»·è‚‰é£¯', price: 35, icon: 'ğŸš' },
            { id: '2', name: 'é›è‚‰é£¯', price: 40, icon: 'ğŸ—' },
            { id: '3', name: 'èšµä»”ç…', price: 65, icon: 'ğŸ³' },
            { id: '4', name: 'å¤§è…¸éºµç·š', price: 50, icon: 'ğŸœ' },
            { id: '5', name: 'çç å¥¶èŒ¶', price: 45, icon: 'ğŸ¥¤' },
            { id: '6', name: 'é¹½é…¥é›', price: 60, icon: 'ğŸ–' },
            { id: '7', name: 'ç”œä¸è¾£', price: 40, icon: 'ğŸ¢' },
            { id: '8', name: 'è‚‰åœ“', price: 45, icon: 'ğŸ¥Ÿ' },
        ];
        
        const ICONS = {
            PLUS: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>,
            MINUS: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M18 12H6" /></svg>,
            TRASH: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
        };
        
        // --- From hooks/useLiff.ts ---
        const useLiff = () => {
            const [liffStatus, setLiffStatus] = useState('initializing');
            const [userProfile, setUserProfile] = useState(null);

            const initializeLiff = useCallback(async () => {
                try {
                    const liff = window.liff;
                    if (!liff) {
                        throw new Error("LIFF SDK not found.");
                    }
                    await liff.init({ liffId: LIFF_ID });

                    if (liff.isLoggedIn()) {
                        const profile = await liff.getProfile();
                        setUserProfile(profile);
                        setLiffStatus('ready');
                    } else {
                        setLiffStatus('logged_out');
                        liff.login();
                    }
                } catch (error) {
                    console.error('LIFF initialization failed', error);
                    setLiffStatus('error');
                }
            }, []);

            useEffect(() => {
                initializeLiff();
            }, [initializeLiff]);

            return { liffStatus, userProfile };
        };

        // --- From hooks/useCart.ts ---
        const useCart = () => {
            const [items, setItems] = useState([]);

            const addToCart = useCallback((menuItem) => {
                setItems((prevItems) => {
                    const existingItem = prevItems.find((item) => item.id === menuItem.id);
                    if (existingItem) {
                        return prevItems.map((item) =>
                            item.id === menuItem.id
                                ? { ...item, quantity: item.quantity + 1 }
                                : item
                        );
                    }
                    return [...prevItems, { ...menuItem, quantity: 1 }];
                });
            }, []);

            const updateQuantity = useCallback((itemId, newQuantity) => {
                if (newQuantity <= 0) {
                    setItems((prevItems) => prevItems.filter((item) => item.id !== itemId));
                } else {
                    setItems((prevItems) =>
                        prevItems.map((item) =>
                            item.id === itemId ? { ...item, quantity: newQuantity } : item
                        )
                    );
                }
            }, []);

            const clearCart = useCallback(() => {
                setItems([]);
            }, []);

            const subtotal = useMemo(() => {
                return items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            }, [items]);

            return { items, addToCart, updateQuantity, clearCart, subtotal };
        };

        // --- From components/Header.tsx ---
        const Header = ({ onBack }) => {
            return (
                <header className="header">
                    {onBack && (
                        <button onClick={onBack} className="back-button" aria-label="è¿”å›">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                    )}
                    <h1>ğŸœ å°ç£å°åƒåº—</h1>
                    <p>LINE å¿«é€Ÿè¨‚é¤</p>
                    <div className="header-decorator"></div>
                </header>
            );
        };

        // --- From components/LiffStatus.tsx ---
        const LiffStatusDisplay = ({ status, profile }) => {
            const getStatusProps = () => {
                switch (status) {
                    case 'initializing': return { text: 'ğŸ”„ åˆå§‹åŒ– LINE åŠŸèƒ½ä¸­...', type: 'initializing' };
                    case 'ready': return { text: `âœ… æ­¡è¿ï¼Œ${profile?.displayName || 'ç”¨æˆ¶'}`, type: 'ready' };
                    case 'logged_out': return { text: 'ğŸ”„ æ­£åœ¨å°å‘ LINE ç™»å…¥é é¢...', type: 'logged_out' };
                    case 'error': return { text: 'âŒ LINE åŠŸèƒ½è¼‰å…¥å¤±æ•—ï¼Œä½†ä»å¯è¨‚é¤', type: 'error' };
                    default: return { text: '', type: '' };
                }
            };
            const { text, type } = getStatusProps();
            return <div className={`liff-status ${type}`}>{text}</div>;
        };

        // --- From components/OrderForm.tsx ---
        const FormGroup = ({ label, required, children, error }) => (
            <div className="form-group">
                <label>
                    {label}
                    {required && <span style={{color: '#ef4444'}}> *</span>}
                </label>
                {children}
                {error && <p className="error-message">{error}</p>}
            </div>
        );

        const OrderForm = ({ customerName, setCustomerName, customerPhone, setCustomerPhone, pickupTime, setPickupTime, deliveryAddress, setDeliveryAddress, notes, setNotes, phoneError, timeError }) => {
            return (
                <React.Fragment>
                    <FormGroup label="å§“å" required>
                        <input type="text" value={customerName} onChange={(e) => setCustomerName(e.target.value)} placeholder="è‡ªå‹•å¸¶å…¥ LINE åç¨±" />
                    </FormGroup>
                    <FormGroup label="æ‰‹æ©Ÿè™Ÿç¢¼" required error={phoneError}>
                        <input type="tel" value={customerPhone} onChange={(e) => setCustomerPhone(e.target.value)} placeholder="0912345678" className={phoneError ? 'error' : ''} />
                    </FormGroup>
                    <FormGroup label="å–é¤æ™‚é–“" required error={timeError}>
                        <input type="datetime-local" value={pickupTime} onChange={(e) => setPickupTime(e.target.value)} className={timeError ? 'error' : ''} />
                    </FormGroup>
                    <FormGroup label="å¤–é€åœ°é» (é¸å¡«)">
                        <input type="text" value={deliveryAddress} onChange={(e) => setDeliveryAddress(e.target.value)} placeholder="å¦‚éœ€å¤–é€è«‹å¡«å¯«åœ°å€" />
                        <p style={{fontSize: '0.75rem', color: '#6b7280', marginTop: '0.25rem', fontStyle: 'italic'}}>â€» å¡«å¯«åœ°å€å°‡è‡ªå‹•åŠ æ”¶ ${DELIVERY_FEE} å¤–é€è²»</p>
                    </FormGroup>
                    <FormGroup label="å‚™è¨» (é¸å¡«)">
                        <textarea rows={2} value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="ä¾‹å¦‚ï¼šä¸è¦é¦™èœã€åŠ è¾£ã€é¤å…·æ•¸é‡ç­‰"></textarea>
                    </FormGroup>
                </React.Fragment>
            );
        };
        
        // --- From components/Menu.tsx ---
        const SectionTitle = ({ children }) => (
            <h2 className="section-title">
                {children}
            </h2>
        );
        const Menu = ({ menuItems, onAddToCart }) => {
            const quickAddItems = menuItems.filter(item => ['æ»·è‚‰é£¯', 'é›è‚‰é£¯', 'çç å¥¶èŒ¶', 'é¹½é…¥é›'].includes(item.name));
            return (
                <div className="menu-container">
                    <SectionTitle>ğŸ“ é¸æ“‡é¤é»</SectionTitle>
                    <label htmlFor="menuSelect" style={{display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', color: '#374151', fontSize: '0.875rem'}}>å¾èœå–®é¸æ“‡</label>
                    <select id="menuSelect" onChange={(e) => {
                        if (e.target.value) {
                            const selectedItem = menuItems.find(item => String(item.id) === e.target.value);
                            if (selectedItem) onAddToCart(selectedItem);
                            e.target.value = "";
                        }
                    }} style={{marginBottom: '1rem'}}>
                        <option value="">-- è«‹é¸æ“‡é¤é» --</option>
                        {menuItems.map(item => <option key={item.id} value={item.id}>{item.icon} {item.name} - ${item.price}</option>)}
                    </select>
                    
                    <label style={{display: 'block', marginBottom: '0.5rem', fontWeight: 'bold', color: '#374151', fontSize: '0.875rem'}}>å¿«é€Ÿé¸æ“‡</label>
                    <div className="quick-add-grid">
                        {quickAddItems.map(item => <button key={item.id} type="button" onClick={() => onAddToCart(item)} className="quick-add-btn">{item.icon} {item.name}</button>)}
                    </div>
                </div>
            );
        };

        // --- From components/Cart.tsx ---
        const Cart = ({ items, onUpdateQuantity }) => {
            return (
                <div className="cart-container">
                    <SectionTitle>ğŸ›’ è¨‚å–®æ˜ç´°</SectionTitle>
                    {items.length === 0 ? (
                        <p style={{textAlign: 'center', color: '#6b7280', fontStyle: 'italic', padding: '1rem 0'}}>å°šæœªé¸æ“‡é¤é»</p>
                    ) : (
                        <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                            {items.map(item => (
                                <div key={item.id} className="cart-item">
                                    <div style={{flexGrow: 1}}>
                                        <p style={{fontWeight: 'bold', color: '#1f2937'}}>{item.icon} {item.name}</p>
                                        <p style={{fontSize: '0.875rem', color: '#4b5563'}}>${item.price} x {item.quantity} = ${item.price * item.quantity}</p>
                                    </div>
                                    <div className="quantity-controls">
                                        <button type="button" onClick={() => onUpdateQuantity(item.id, item.quantity - 1)} className="quantity-btn plus-minus-btn">{ICONS.MINUS}</button>
                                        <span className="quantity-display">{item.quantity}</span>
                                        <button type="button" onClick={() => onUpdateQuantity(item.id, item.quantity + 1)} className="quantity-btn plus-minus-btn">{ICONS.PLUS}</button>
                                        <button type="button" onClick={() => onUpdateQuantity(item.id, 0)} className="quantity-btn trash-btn">{ICONS.TRASH}</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- From components/OrderSummary.tsx ---
        const OrderSummary = ({ subtotal, deliveryFee }) => {
            const total = subtotal + deliveryFee;
            return (
                <div className="summary-container">
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '0.25rem', color: '#374151'}}>
                        <span>é¤é»ç¸½è¨ˆ:</span><span>${subtotal}</span>
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem', color: '#374151'}}>
                        <span>å¤–é€è²»:</span><span>${deliveryFee}</span>
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', paddingTop: '0.5rem', borderTop: '1px solid #bbf7d0', fontWeight: 'bold', fontSize: '1.125rem', color: '#1f2937'}}>
                        <span>ç¸½é‡‘é¡:</span><span>${total}</span>
                    </div>
                </div>
            );
        };
        
        // --- From components/Footer.tsx ---
        const Footer = () => {
            return (
                <footer className="footer">
                    <p>ğŸ“ ç‡Ÿæ¥­æ™‚é–“: 10:00-21:00</p>
                    <p>ğŸ“ è¯çµ¡é›»è©±: 02-1234-5678</p>
                    <p style={{marginTop: '0.5rem', opacity: 0.7}}>ç³»çµ±ç‰ˆæœ¬: 5.1.0 (Pre-configured)</p>
                </footer>
            );
        };

        // --- From components/Notification.tsx ---
        const Notification = ({ notification, onClose }) => {
            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => onClose(), 6000);
                    return () => clearTimeout(timer);
                }
            }, [notification, onClose]);

            if (!notification) return null;

            return (
                <div className={`notification-toast ${notification.type} ${!notification ? 'hidden' : ''}`}>
                    <p>{notification.type.toUpperCase()}</p>
                    <p>{notification.message}</p>
                </div>
            );
        };
        
        // --- From components/LoadingOverlay.tsx ---
        const LoadingOverlay = ({ isLoading, text = "è™•ç†ä¸­..." }) => {
            if (!isLoading) return null;
            return (
                <div className="loading-overlay">
                    <div className="spinner"></div>
                    <p className="loading-text">{text}</p>
                </div>
            );
        };
        
        // --- From components/RichMenuDashboard.tsx ---
        const RICH_MENU_ICONS = {
            ONLINE_ORDER: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.63,16.27V14.14H19.37v2.13c0,1.4-1.12,2.53-2.5,2.53H7.13C5.75,18.8,4.63,17.67,4.63,16.27M19.37,12.7H4.63a3.5,3.5,0,0,1-3.5-3.5,1,1,0,0,1,1-1H21.87a1,1,0,0,1,1,1,3.5,3.5,0,0,1-3.5,3.5Z"/><path d="M7.89,6.5A2.74,2.74,0,0,1,5.63,4.6,2.68,2.68,0,0,1,7.2,2.13a.75.75,0,1,1,.7,1.3,1.21,1.21,0,0,0-.49.88,1.22,1.22,0,0,0,1.21,1.22.75.75,0,0,1,0,1.5,2.71,2.71,0,0,1-1.07-.23Z"/><path d="M12.37,6.5a2.74,2.74,0,0,1-2.26-1.9,2.68,2.68,0,0,1,1.57-2.47.75.75,0,1,1,.7,1.3,1.21,1.21,0,0,0-.49.88,1.22,1.22,0,0,0,1.21,1.22.75.75,0,0,1,0,1.5,2.71,2.71,0,0,1-1.07-.23Z"/><path d="M16.84,6.5a2.74,2.74,0,0,1-2.26-1.9,2.68,2.68,0,0,1,1.57-2.47.75.75,0,1,1,.7,1.3,1.21,1.21,0,0,0-.49.88,1.22,1.22,0,0,0,1.21,1.22.75.75,0,0,1,0,1.5,2.71,2.71,0,0,1-1.07-.23Z"/></svg>,
            VIEW_MENU: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14,2H6A2,2,0,0,0,4,4V20a2,2,0,0,0,2,2H18a2,2,0,0,0,2-2V8Zm2,16H8V16h8Zm0-4H8V12h8Zm-2-6V4.5L18.5,9Z"/></svg>,
            CONTACT: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1,0,0,1,21,16.5V20a1,1,0,0,1-1,1C10.21,21 3,13.79 3,4A1,1,0,0,1,4,3H7.5A1,1,0,0,1,8.5,4c0,1.25,0.2,2.45,0.57,3.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/></svg>,
            ORDER_INQUIRY: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.5,3A6.5,6.5,0,0,1,16,9.5c0,1.61-.59,3.09-1.57,4.23l.27.27h.79l5,5-1.5,1.5-5-5v-.79l-.27-.27A6.5,6.5,0,0,1,9.5,16,6.5,6.5,0,0,1,3,9.5,6.5,6.5,0,0,1,9.5,3M9.5,5C7,5,5,7,5,9.5S7,14,9.5,14,14,12,14,9.5,12,5,9.5,5Z"/></svg>,
            LOCATION: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12,11.5A2.5,2.5,0,0,1,9.5,9A2.5,2.5,0,0,1,12,6.5A2.5,2.5,0,0,1,14.5,9A2.5,2.5,0,0,1,12,11.5M12,2A7,7,0,0,0,5,9c0,5.25,7,13,7,13s7-7.75,7-13A7,7,0,0,0,12,2Z"/></svg>,
            PROMOTIONS: <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.3,12.5l-0.8,3.3l-0.8-3.3l-3.3-0.8l3.3-0.8l0.8-3.3l0.8,3.3l3.3,0.8L12.3,12.5z M19.3,9.3l-1.4,0.4l-0.4-1.4l1.4-0.4L19.3,9.3z M19.3,18.7l-1.4-0.4l-0.4,1.4l1.4,0.4L19.3,18.7z M4.7,9.3l1.4,0.4l0.4-1.4L4.7,7.9L4.7,9.3z M12,2L9.5,9.5L2,12l7.5,2.5L12,22l2.5-7.5L22,12L14.5,9.5L12,2z"/></svg>,
        };
        const MenuButton = ({ icon, label, onClick, bgColorClass }) => (
            <button onClick={onClick} className={`menu-button ${bgColorClass}`}>
                {icon}
                <span>{label}</span>
            </button>
        );
        const RichMenuDashboard = ({ onNavigateToOrder, liffHook, showNotification }) => {
            const { liffStatus, userProfile } = liffHook;

            const handleViewMenu = onNavigateToOrder;
            const handleContactSupport = () => alert('ğŸ“ è¯çµ¡å®¢æœè«‹æ’¥æ‰“: 02-1234-5678');
            const handleOrderInquiry = () => showNotification({ type: 'warning', message: 'è¨‚å–®æŸ¥è©¢åŠŸèƒ½å³å°‡æ¨å‡ºï¼Œæ•¬è«‹æœŸå¾…ï¼' });
            const handleLocationInfo = () => alert('ğŸ“ æœ¬åº—åœ°å€ï¼š\nå°åŒ—å¸‚ä¿¡ç¾©å€å¸‚åºœè·¯45è™Ÿ\n\nğŸ•’ ç‡Ÿæ¥­æ™‚é–“: 10:00-21:00');
            const handlePromotions = () => showNotification({ type: 'success', message: 'ç›®å‰æ²’æœ‰ç‰¹åˆ¥çš„å„ªæƒ æ´»å‹•ï¼Œä½†æˆ‘å€‘çš„æ»·è‚‰é£¯å¤©å¤©éƒ½å¥½åƒï¼' });

            return (
                <div className="screen">
                    <Header />
                    <main className="screen-main">
                        <LiffStatusDisplay status={liffStatus} profile={userProfile} />
                        <div className="rich-menu-grid">
                            <MenuButton icon={RICH_MENU_ICONS.ONLINE_ORDER} label="ç·šä¸Šè¨‚é¤" onClick={onNavigateToOrder} bgColorClass="bg-green-600" />
                            <MenuButton icon={RICH_MENU_ICONS.VIEW_MENU} label="æŸ¥çœ‹èœå–®" onClick={handleViewMenu} bgColorClass="bg-blue-500" />
                            <MenuButton icon={RICH_MENU_ICONS.CONTACT} label="è¯çµ¡å®¢æœ" onClick={handleContactSupport} bgColorClass="bg-orange-500" />
                            <MenuButton icon={RICH_MENU_ICONS.ORDER_INQUIRY} label="è¨‚å–®æŸ¥è©¢" onClick={handleOrderInquiry} bgColorClass="bg-purple-500" />
                            <MenuButton icon={RICH_MENU_ICONS.LOCATION} label="ä½ç½®è³‡è¨Š" onClick={handleLocationInfo} bgColorClass="bg-red-600" />
                            <MenuButton icon={RICH_MENU_ICONS.PROMOTIONS} label="å„ªæƒ æ´»å‹•" onClick={handlePromotions} bgColorClass="bg-yellow-600" />
                        </div>
                    </main>
                    <Footer />
                </div>
            );
        };

        // --- From components/OrderScreen.tsx ---
        const OrderScreen = ({ onBack, liffHook, showNotification, menuItems, gasUrl }) => {
            const { liffStatus, userProfile } = liffHook;
            const { items: cartItems, addToCart, updateQuantity, clearCart, subtotal } = useCart();
            
            const [customerName, setCustomerName] = useState('');
            const [customerPhone, setCustomerPhone] = useState('');
            const [pickupTime, setPickupTime] = useState('');
            const [deliveryAddress, setDeliveryAddress] = useState('');
            const [notes, setNotes] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [phoneError, setPhoneError] = useState('');
            const [timeError, setTimeError] = useState('');

            const deliveryFee = deliveryAddress.trim() ? DELIVERY_FEE : 0;
            const isOrderSubmittable = cartItems.length > 0;

            const setDefaultPickupTime = useCallback(() => {
                const now = new Date();
                now.setMinutes(now.getMinutes() + 30);
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                setPickupTime(`${year}-${month}-${day}T${hours}:${minutes}`);
            }, []);

            useEffect(() => { setDefaultPickupTime(); }, [setDefaultPickupTime]);
            useEffect(() => { if (userProfile?.displayName) { setCustomerName(userProfile.displayName); } }, [userProfile]);
            
            const handleAddToCart = (item) => {
                addToCart(item);
                showNotification({ type: 'success', message: `å·²æ·»åŠ  ${item.name}` });
            };

            const validateForm = () => {
                let isValid = true;
                if (!/^09\d{8}$/.test(customerPhone)) { setPhoneError('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ (09é–‹é ­ï¼Œ10ä½æ•¸å­—)'); isValid = false; } else { setPhoneError(''); }
                if (!pickupTime) { setTimeError('è«‹é¸æ“‡å–é¤æ™‚é–“'); isValid = false; }
                else if (new Date(pickupTime) < new Date()) { setTimeError('å–é¤æ™‚é–“ä¸èƒ½æ˜¯éå»çš„æ™‚é–“'); isValid = false; }
                else { setTimeError(''); }
                if (cartItems.length === 0) { showNotification({ type: 'error', message: 'è«‹é¸æ“‡è‡³å°‘ä¸€æ¨£é¤é»' }); isValid = false; }
                if (!customerName.trim()) { showNotification({ type: 'error', message: 'è«‹è¼¸å…¥æ‚¨çš„å§“å' }); isValid = false; }
                return isValid;
            };
            
            const resetForm = useCallback(() => {
                clearCart(); setCustomerPhone(''); setDeliveryAddress(''); setNotes(''); setPhoneError(''); setTimeError('');
                if (userProfile?.displayName) { setCustomerName(userProfile.displayName); }
                setDefaultPickupTime();
            }, [clearCart, setDefaultPickupTime, userProfile]);

            const handleOrderSubmit = async () => {
                if (!validateForm()) return;
                setIsLoading(true);
                
                const itemsForBackend = cartItems.map(({ id, name, price, quantity }) => ({ id, name, price, quantity }));

                const orderData = {
                    customerName: customerName.trim(),
                    customerPhone: customerPhone.trim(),
                    customerLineUserId: userProfile?.userId || 'æœªç¶å®š',
                    items: itemsForBackend,
                    subtotal: subtotal,
                    deliveryFee: deliveryFee,
                    totalAmount: subtotal + deliveryFee,
                    pickupTime: new Date(pickupTime).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' }),
                    deliveryAddress: deliveryAddress.trim() || 'ç„¡',
                    notes: notes.trim() || 'ç„¡',
                    paymentMethod: 'ç¾å ´ä»˜æ¬¾'
                };
                
                try {
                    const response = await fetch(gasUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Use text/plain to avoid CORS preflight
                        body: JSON.stringify({ action: 'submitOrder', orderData: orderData }),
                        redirect: 'follow'
                    });
                    
                    if (!response.ok) {
                        let errorMsg = `ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`;
                        try {
                            const errData = await response.json();
                            errorMsg = errData.error || errorMsg;
                        } catch (e) { /* response might not be json */ }
                        throw new Error(errorMsg);
                    }

                    const result = await response.json();

                    if (result.success) {
                        showNotification({ type: 'success', message: `${result.message}ï¼è¨‚å–®ç·¨è™Ÿ: ${result.orderId}ã€‚ç¢ºèªè¨Šæ¯å°‡é€é LINE ç™¼é€ã€‚` });
                        resetForm();
                        onBack();
                    } else {
                        throw new Error(result.error || 'å¾Œç«¯å›å ±è¨‚å–®æäº¤å¤±æ•—');
                    }
                } catch (error) {
                    showNotification({ type: 'error', message: `è¨‚å–®ç™¼é€å¤±æ•—ï¼š${error instanceof Error ? error.message : String(error)}` });
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="screen">
                    <LoadingOverlay isLoading={isLoading} text="è¨‚å–®ç™¼é€ä¸­..." />
                    <Header onBack={onBack}/>
                    <main className="screen-main">
                        <LiffStatusDisplay status={liffStatus} profile={userProfile} />
                        <OrderForm {...{ customerName, setCustomerName, customerPhone, setCustomerPhone, pickupTime, setPickupTime, deliveryAddress, setDeliveryAddress, notes, setNotes, phoneError, timeError }}/>
                        <Menu menuItems={menuItems} onAddToCart={handleAddToCart} />
                        <Cart items={cartItems} onUpdateQuantity={updateQuantity} />
                        <OrderSummary subtotal={subtotal} deliveryFee={deliveryFee} />
                        <button onClick={handleOrderSubmit} disabled={!isOrderSubmittable || isLoading} className="submit-btn">âœ… é€å‡ºè¨‚å–®</button>
                    </main>
                    <Footer />
                </div>
            );
        };
        
        // --- From App.tsx ---
        const App = () => {
            const [view, setView] = useState('menu');
            const [notification, setNotification] = useState(null);
            const [menuItems, setMenuItems] = useState([]);
            const [menuStatus, setMenuStatus] = useState('loading'); // 'loading', 'loaded', 'error'
            const liffHook = useLiff();
            
            const showNotification = useCallback((notification) => {
                setNotification(notification);
            }, []);
            
            useEffect(() => {
                const fetchMenu = async () => {
                    try {
                        const response = await fetch(GAS_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({ action: 'getMenu' }),
                            redirect: 'follow',
                        });

                        if (!response.ok) throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
                        const data = await response.json();
                        if (!Array.isArray(data)) throw new Error("å¾ä¼ºæœå™¨æ”¶åˆ°çš„èœå–®æ ¼å¼ä¸æ­£ç¢ºã€‚");

                        const menuWithIcons = data
                            .filter(item => item.available)
                            .map(item => {
                                const localItem = FALLBACK_MENU_ITEMS.find(mi => mi.id === String(item.id));
                                return { ...item, icon: localItem ? localItem.icon : 'ğŸ²' };
                            });

                        setMenuItems(menuWithIcons);
                        setMenuStatus('loaded');
                    } catch (error) {
                        console.error('Failed to fetch menu:', error);
                        showNotification({ type: 'error', message: `ç„¡æ³•è¼‰å…¥èœå–®ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–å¾Œç«¯è¨­å®šã€‚å°‡ä½¿ç”¨å‚™ç”¨èœå–®ã€‚` });
                        setMenuItems(FALLBACK_MENU_ITEMS);
                        setMenuStatus('error');
                    }
                };

                fetchMenu();
            }, [showNotification]);

            if (menuStatus === 'loading') {
                return (
                    <div className="app-container">
                        <LoadingOverlay isLoading={true} text="èœå–®è¼‰å…¥ä¸­..." />
                    </div>
                );
            }
    
            return (
                <div className="app-container">
                    <Notification notification={notification} onClose={() => setNotification(null)} />
                    {view === 'menu' ? (
                        <RichMenuDashboard onNavigateToOrder={() => setView('order')} liffHook={liffHook} showNotification={showNotification}/>
                    ) : (
                        <OrderScreen onBack={() => setView('menu')} liffHook={liffHook} showNotification={showNotification} menuItems={menuItems} gasUrl={GAS_URL} />
                    )}
                </div>
            );
        };
        
        // --- From index.tsx ---
        const rootElement = document.getElementById('root');
        const root = createRoot(rootElement);
        root.render(
            <StrictMode>
                <App />
            </StrictMode>
        );
    })();
    </script>
</body>
</html>
