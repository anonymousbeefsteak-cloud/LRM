<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£å°åƒåº— - LINEè¨‚é¤ç³»çµ±</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary: #16a34a;
            --primary-dark: #15803d;
            --danger: #ef4444;
            --gray: #6b7280;
            --border: #e5e7eb;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; background: linear-gradient(to bottom right, #f0fdf4, #eff6ff); min-height: 100vh; padding: 24px 12px; }
        .container { max-width: 28rem; margin: auto; background: white; border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .header { background: var(--primary); color: white; padding: 20px; text-align: center; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; }
        .header h1 { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .header p { opacity: 0.9; font-size: 0.875rem; margin: 4px 0 0; }
        .main { padding: 20px; }
        .footer { text-align: center; padding: 1rem; color: var(--gray); font-size: 0.75rem; border-top: 1px solid var(--border); background: #f9fafb; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; }
        .section-title { font-size: 1.125rem; font-weight: bold; text-align: center; color: #1f2937; margin-bottom: 24px; position: relative; }
        .section-title::after { content: ''; position: absolute; bottom: -8px; left: 25%; right: 25%; height: 2px; background: var(--primary); }
        .liff-status { padding: 0.75rem; margin-bottom: 1rem; border-radius: 0.5rem; font-size: 0.875rem; text-align: center; border: 1px solid; }
        .liff-status.initializing { background: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; }
        .liff-status.ready { background: #dcfce7; border-color: #4ade80; color: #166534; }
        .liff-status.logged_out { background: #fefce8; border-color: #facc15; color: #854d0e; }
        .liff-status.error { background: #fee2e2; border-color: #f87171; color: #991b1b; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: #374151; font-size: 0.875rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.5); }
        .form-group.error input, .form-group.error textarea { border-color: var(--danger); }
        .error-message { color: var(--danger); font-size: 0.75rem; margin-top: 0.25rem; }
        .menu-container, .cart-container, .summary-container { padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border); margin: 1rem 0; }
        .menu-container { background: #f9fafb; }
        .cart-container { background: #fefce8; border-color: #fde68a; }
        .summary-container { background: #f0fdf4; border-color: #bbf7d0; }
        .quick-add-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        @media (min-width: 640px) { .quick-add-grid { grid-template-columns: repeat(4, 1fr); } }
        .quick-add-btn { padding: 0.5rem; border: 1px solid var(--primary); color: #166534; border-radius: 0.375rem; font-size: 0.875rem; }
        .quick-add-btn:hover { background: var(--primary); color: white; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #fde68a; }
        .cart-item:last-child { border-bottom: none; }
        .quantity-controls { display: flex; align-items: center; gap: 0.5rem; }
        .quantity-btn, .remove-btn { width: 1.75rem; height: 1.75rem; display: flex; align-items: center; justify-content: center; border-radius: 9999px; color: white; }
        .quantity-btn { background: var(--primary); }
        .quantity-btn:hover { background: var(--primary-dark); transform: scale(1.1); }
        .remove-btn { background: var(--danger); margin-left: 0.5rem; }
        .remove-btn:hover { background: #dc2626; transform: scale(1.1); }
        .quantity-display { width: 1.5rem; text-align: center; font-weight: bold; }
        .submit-btn { width: 100%; padding: 1rem; background: var(--primary); color: white; border-radius: 0.5rem; font-weight: bold; font-size: 1.125rem; }
        .submit-btn:hover:not(:disabled) { background: var(--primary-dark); transform: scale(1.05); }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .notification { position: fixed; top: 1.25rem; right: 1.25rem; max-width: 24rem; padding: 1rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .notification.success { background: var(--primary); }
        .notification.error { background: var(--danger); }
        .notification.info { background: #3b82f6; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 4rem; height: 4rem; border: 4px solid #e5e7eb; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 1rem; font-size: 1.125rem; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }
        .status-online { background: #22c55e; }
        .status-offline { background: #f87171; }
        .liff-actions { margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: center; }
        .liff-btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: bold; }
        .liff-btn.primary { background: var(--primary); color: white; }
        .liff-btn.primary:hover { background: var(--primary-dark); }
        .liff-btn.secondary { background: #6b7280; color: white; }
        .liff-btn.secondary:hover { background: #4b5563; }
        .notification-status { padding: 0.5rem; margin-top: 0.5rem; border-radius: 0.375rem; }
        .notification-status.success { background: #dcfce7; color: #166534; }
        .notification-status.error { background: #fee2e2; color: #991b1b; }
        #lineGuide { margin-bottom: 1rem; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸœ å°ç£å°åƒåº—</h1>
            <p>LINE å¿«é€Ÿè¨‚é¤</p>
        </header>
        <main class="main">
            <div id="liffStatus" class="liff-status initializing">
                <span class="status-indicator status-offline"></span> æ­£åœ¨åˆå§‹åŒ– LINE åŠŸèƒ½...
            </div>
            <div id="lineGuide" style="display: none;">
                <h3><i class="fab fa-line"></i> è«‹åœ¨ LINE App ä¸­é–‹å•Ÿ</h3>
                <p>é–‹å•Ÿ LINE ä»¥ç²å¾—å®Œæ•´åŠŸèƒ½</p>
                <div class="liff-actions">
                    <button class="liff-btn primary" onclick="openInLineApp()">
                        <i class="fas fa-sign-in-alt"></i> åœ¨ LINE ä¸­é–‹å•Ÿ
                    </button>
                    <button class="liff-btn secondary" onclick="enableBasicMode()">
                        <i class="fas fa-shopping-cart"></i> ç¹¼çºŒè¨‚é¤
                    </button>
                </div>
            </div>
            <div id="userInfo" style="display: none;"></div>
            <div class="form-group">
                <label>å§“å <span style="color: var(--danger);">*</span></label>
                <input id="customerName" type="text" placeholder="è‡ªå‹•å¸¶å…¥ LINE åç¨±">
            </div>
            <div class="form-group" id="phoneGroup">
                <label>æ‰‹æ©Ÿè™Ÿç¢¼ <span style="color: var(--danger);">*</span></label>
                <input id="customerPhone" type="tel" placeholder="0912345678">
                <p id="phoneError" class="error-message" style="display: none;">è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼ (09é–‹é ­ï¼Œ10ä½æ•¸å­—)</p>
            </div>
            <div class="form-group" id="timeGroup">
                <label>å–é¤æ™‚é–“ <span style="color: var(--danger);">*</span></label>
                <input id="pickupTime" type="datetime-local">
                <p id="timeError" class="error-message" style="display: none;">è«‹é¸æ“‡å–é¤æ™‚é–“</p>
            </div>
            <div class="form-group">
                <label>å¤–é€åœ°é» (é¸å¡«)</label>
                <input id="deliveryAddress" type="text" placeholder="å¦‚éœ€å¤–é€è«‹å¡«å¯«åœ°å€">
                <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem; font-style: italic;">â€» å¡«å¯«åœ°å€å°‡è‡ªå‹•åŠ æ”¶ $30 å¤–é€è²»</p>
            </div>
            <div class="form-group">
                <label>å‚™è¨» (é¸å¡«)</label>
                <textarea id="notes" rows="2" placeholder="ä¾‹å¦‚ï¼šä¸è¦é¦™èœã€åŠ è¾£ã€é¤å…·æ•¸é‡ç­‰"></textarea>
            </div>
            <div class="menu-container">
                <h2 class="section-title">ğŸ“ é¸æ“‡é¤é»</h2>
                <label>å¾èœå–®é¸æ“‡</label>
                <select id="menuSelect">
                    <option value="">-- è«‹é¸æ“‡é¤é» --</option>
                    <option value="æ»·è‚‰é£¯">ğŸš æ»·è‚‰é£¯ - $35</option>
                    <option value="é›è‚‰é£¯">ğŸ— é›è‚‰é£¯ - $40</option>
                    <option value="èšµä»”ç…">ğŸ³ èšµä»”ç… - $65</option>
                    <option value="å¤§è…¸éºµç·š">ğŸœ å¤§è…¸éºµç·š - $50</option>
                    <option value="çç å¥¶èŒ¶">ğŸ¥¤ çç å¥¶èŒ¶ - $45</option>
                    <option value="é¹½é…¥é›">ğŸ– é¹½é…¥é› - $60</option>
                    <option value="ç”œä¸è¾£">ğŸ¢ ç”œä¸è¾£ - $40</option>
                    <option value="è‚‰åœ“">ğŸ¥Ÿ è‚‰åœ“ - $45</option>
                </select>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border);">
                    <label>å¿«é€Ÿé¸æ“‡</label>
                    <div class="quick-add-grid">
                        <button type="button" class="quick-add-btn" onclick="quickAdd('æ»·è‚‰é£¯')">ğŸš æ»·è‚‰é£¯</button>
                        <button type="button" class="quick-add-btn" onclick="quickAdd('é›è‚‰é£¯')">ğŸ— é›è‚‰é£¯</button>
                        <button type="button" class="quick-add-btn" onclick="quickAdd('çç å¥¶èŒ¶')">ğŸ¥¤ çç å¥¶èŒ¶</button>
                        <button type="button" class="quick-add-btn" onclick="quickAdd('é¹½é…¥é›')">ğŸ– é¹½é…¥é›</button>
                    </div>
                </div>
            </div>
            <div class="cart-container">
                <h2 class="section-title">ğŸ›’ è¨‚å–®æ˜ç´°</h2>
                <div id="cartItems">
                    <div class="empty-cart">å°šæœªé¸æ“‡é¤é»</div>
                </div>
            </div>
            <div class="summary-container">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                    <span>é¤é»ç¸½è¨ˆ:</span><span id="subtotal">$0</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>å¤–é€è²»:</span><span id="deliveryFee">$0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 1px solid #bbf7d0; font-weight: bold; font-size: 1.125rem;">
                    <span>ç¸½é‡‘é¡:</span><span id="totalAmount">$0</span>
                </div>
                <div id="notificationStatus"></div>
            </div>
            <button id="submitBtn" class="submit-btn" onclick="submitOrder()" disabled>âœ… é€å‡ºè¨‚å–®</button>
            <div id="loading" class="loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <p class="loading-text">è¨‚å–®ç™¼é€ä¸­...</p>
            </div>
            <div id="notification" class="notification" style="display: none;"></div>
        </main>
        <footer class="footer">
            <p>ğŸ“ ç‡Ÿæ¥­æ™‚é–“: 10:00-21:00</p>
            <p>ğŸ“ è¯çµ¡é›»è©±: 02-1234-5678</p>
            <p style="margin-top: 0.5rem; opacity: 0.7;">ç³»çµ±ç‰ˆæœ¬: 1.0.0</p>
        </footer>
    </div>
    <script>
        // ç³»çµ±é…ç½®
        const CONFIG = {
            LIFF_ID: '2008316489-6nMjb0KX',
            API_ENDPOINT: 'ä½ çš„ Google Apps Script Web App URL'
        };

        // èœå–®åƒ¹æ ¼
        const menuPrices = {
            'æ»·è‚‰é£¯': 35,
            'é›è‚‰é£¯': 40,
            'èšµä»”ç…': 65,
            'å¤§è…¸éºµç·š': 50,
            'çç å¥¶èŒ¶': 45,
            'é¹½é…¥é›': 60,
            'ç”œä¸è¾£': 40,
            'è‚‰åœ“': 45
        };

        // é¤é»åœ–ç¤º
        const menuIcons = {
            'æ»·è‚‰é£¯': 'ğŸš',
            'é›è‚‰é£¯': 'ğŸ—',
            'èšµä»”ç…': 'ğŸ³',
            'å¤§è…¸éºµç·š': 'ğŸœ',
            'çç å¥¶èŒ¶': 'ğŸ¥¤',
            'é¹½é…¥é›': 'ğŸ–',
            'ç”œä¸è¾£': 'ğŸ¢',
            'è‚‰åœ“': 'ğŸ¥Ÿ'
        };

        let cart = [];
        let userProfile = null;
        let isLineMode = false;
        let isBasicMode = false;

        // åœ¨ LINE App ä¸­é–‹å•Ÿ
        function openInLineApp() {
            const lineUrl = `https://line.me/R/app/${CONFIG.LIFF_ID}`;
            window.open(lineUrl, '_blank');
            showNotification('è«‹åœ¨ LINE App ä¸­é–‹å•Ÿé€£çµ', 'info', 4000);
        }

        // å•Ÿç”¨åŸºæœ¬æ¨¡å¼
        function enableBasicMode() {
            isBasicMode = true;
            document.getElementById('lineGuide').style.display = 'none';
            document.getElementById('liffStatus').innerHTML = 
                '<span class="status-indicator status-offline"></span> åŸºæœ¬è¨‚é¤æ¨¡å¼<br><small style="color: var(--gray);">éƒ¨åˆ†åŠŸèƒ½å—é™</small>';
            showNotification('å·²å•Ÿç”¨åŸºæœ¬è¨‚é¤æ¨¡å¼', 'info', 3000);
        }

        // åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                const isInLine = navigator.userAgent.includes('Line') || 
                                window.location.href.includes('liff.state') ||
                                document.referrer.includes('line.me');
                
                if (!isInLine) {
                    document.getElementById('liffStatus').innerHTML = 
                        '<span class="status-indicator status-offline"></span> è«‹åœ¨ LINE App ä¸­é–‹å•Ÿä»¥ç²å¾—å®Œæ•´åŠŸèƒ½';
                    document.getElementById('lineGuide').style.display = 'block';
                    return;
                }

                document.getElementById('liffStatus').innerHTML = 
                    '<span class="status-indicator status-offline"></span> æ­£åœ¨åˆå§‹åŒ– LINE åŠŸèƒ½...';
                
                await liff.init({ liffId: CONFIG.LIFF_ID });

                if (liff.isLoggedIn()) {
                    userProfile = await liff.getProfile();
                    isLineMode = true;
                    document.getElementById('customerName').value = userProfile.displayName;
                    document.getElementById('userInfo').innerHTML = `
                        <span class="status-indicator status-online"></span> 
                        LINE å¸³è™Ÿå·²ç¶å®š<br>
                        ğŸ‘‹ æ­¡è¿ï¼Œ${userProfile.displayName}
                    `;
                    document.getElementById('userInfo').style.display = 'block';
                    document.getElementById('liffStatus').innerHTML = 
                        '<span class="status-indicator status-online"></span> LINE æ¨¡å¼å·²å°±ç·’';
                    document.getElementById('lineGuide').style.display = 'none';
                    liff.sendMessages([{type: 'text', text: 'æ­¡è¿ä½¿ç”¨è¨‚é¤ç³»çµ±ï¼'}]);
                } else {
                    document.getElementById('liffStatus').innerHTML = 
                        '<span class="status-indicator status-offline"></span> è«‹ç™»å…¥ LINE å¸³è™Ÿ';
                    document.getElementById('lineGuide').innerHTML = `
                        <h3><i class="fab fa-line"></i> è«‹ç™»å…¥ LINE å¸³è™Ÿ</h3>
                        <p>ç™»å…¥å¾Œå¯è‡ªå‹•å¡«å¯«å§“åä¸¦æ¥æ”¶è¨‚å–®é€šçŸ¥</p>
                        <div class="liff-actions">
                            <button class="liff-btn primary" onclick="liff.login()">
                                <i class="fas fa-sign-in-alt"></i> ç™»å…¥ LINE
                            </button>
                            <button class="liff-btn secondary" onclick="enableBasicMode()">
                                <i class="fas fa-shopping-cart"></i> ç¹¼çºŒè¨‚é¤
                            </button>
                        </div>
                    `;
                    document.getElementById('lineGuide').style.display = 'block';
                }
            } catch (error) {
                console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
                let errorMessage = 'LINE åŠŸèƒ½è¼‰å…¥å¤±æ•—';
                if (error.message.includes('LIFF_ID')) {
                    errorMessage = 'LIFF è¨­å®šéŒ¯èª¤ï¼Œè«‹è¯çµ¡åº—å®¶';
                } else if (error.message.includes('invalid id')) {
                    errorMessage = 'ç„¡æ•ˆçš„ LIFF ID';
                } else if (error.message.includes('Network Error')) {
                    errorMessage = 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯';
                }
                document.getElementById('liffStatus').innerHTML = 
                    `<span class="status-indicator status-offline"></span> ${errorMessage}`;
                document.getElementById('lineGuide').style.display = 'block';
            }
        }

        // ä¿®å¾©çš„ API èª¿ç”¨å‡½æ•¸
        function submitOrderViaGet(orderData) {
            return new Promise((resolve, reject) => {
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'createOrder');
                    params.append('data', JSON.stringify(orderData));
                    const url = `${CONFIG.API_ENDPOINT}?${params.toString()}`;
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            return response.json();
                        })
                        .then(result => resolve(result))
                        .catch(error => reject(error));
                } catch (error) {
                    reject(error);
                }
            });
        }

        // å¿«é€Ÿæ·»åŠ é¤é»
        function quickAdd(itemName) {
            const existingItem = cart.find(item => item.name === itemName);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    name: itemName,
                    price: menuPrices[itemName],
                    quantity: 1
                });
            }
            renderCart();
            updateOrderSummary();
            showNotification(`å·²æ·»åŠ  ${itemName}`, 'success', 2000);
        }

        // æ·»åŠ åˆ°è³¼ç‰©è»Š
        function addToCart() {
            const menuSelect = document.getElementById('menuSelect');
            const selectedItem = menuSelect.value;
            if (!selectedItem) return;
            const existingItem = cart.find(item => item.name === selectedItem);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    name: selectedItem,
                    price: menuPrices[selectedItem],
                    quantity: 1
                });
            }
            menuSelect.value = '';
            renderCart();
            updateOrderSummary();
            showNotification(`å·²æ·»åŠ  ${selectedItem}`, 'success', 2000);
        }

        // æ¸²æŸ“è³¼ç‰©è»Š
        function renderCart() {
            const cartItems = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartItems.innerHTML = '<div class="empty-cart">å°šæœªé¸æ“‡é¤é»</div>';
                return;
            }
            cartItems.innerHTML = cart.map(item => `
                <div class="cart-item">
                    <div>
                        <strong>${menuIcons[item.name]} ${item.name}</strong>
                        <div style="font-size: 13px; color: var(--gray);">
                            $${item.price} x ${item.quantity} = $${item.price * item.quantity}
                        </div>
                    </div>
                    <div class="quantity-controls">
                        <button class="quantity-btn" onclick="adjustQuantity('${item.name}', -1)">-</button>
                        <span class="quantity-display">${item.quantity}</span>
                        <button class="quantity-btn" onclick="adjustQuantity('${item.name}', 1)">+</button>
                        <button class="remove-btn" onclick="removeItem('${item.name}')">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // èª¿æ•´æ•¸é‡
        function adjustQuantity(itemName, change) {
            const item = cart.find(item => item.name === itemName);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeItem(itemName);
                } else {
                    renderCart();
                    updateOrderSummary();
                }
            }
        }

        // ç§»é™¤é …ç›®
        function removeItem(itemName) {
            cart = cart.filter(item => item.name !== itemName);
            renderCart();
            updateOrderSummary();
            showNotification(`å·²ç§»é™¤ ${itemName}`, 'success', 2000);
        }

        // æ›´æ–°è¨‚å–®ç¸½è¨ˆ
        function updateOrderSummary() {
            let subtotal = 0;
            cart.forEach(item => {
                subspace += item.price * item.quantity;
            });
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const deliveryFee = deliveryAddress ? 30 : 0;
            const total = subtotal + deliveryFee;
            document.getElementById('subtotal').textContent = `$${subtotal}`;
            document.getElementById('deliveryFee').textContent = `$${deliveryFee}`;
            document.getElementById('totalAmount').textContent = `$${total}`;
            document.getElementById('submitBtn').disabled = cart.length === 0;
        }

        // é©—è­‰è¡¨å–®
        function validateForm() {
            let isValid = true;
            const customerName = document.getElementById('customerName').value.trim();
            if (!customerName) {
                document.getElementById('customerName').style.borderColor = 'var(--danger)';
                isValid = false;
            } else {
                document.getElementById('customerName').style.borderColor = '';
            }
            const phone = document.getElementById('customerPhone').value.trim();
            const phoneRegex = /^09\d{8}$/;
            if (!phoneRegex.test(phone)) {
                document.getElementById('phoneGroup').classList.add('error');
                document.getElementById('phoneError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('phoneGroup').classList.remove('error');
                document.getElementById('phoneError').style.display = 'none';
            }
            const pickupTime = document.getElementById('pickupTime').value;
            if (!pickupTime) {
                document.getElementById('timeGroup').classList.add('error');
                document.getElementById('timeError').style.display = 'block';
                isValid = false;
            } else if (new Date(pickupTime) < new Date()) {
                document.getElementById('timeGroup').classList.add('error');
                document.getElementById('timeError').textContent = 'å–é¤æ™‚é–“ä¸èƒ½æ˜¯éå»æ™‚é–“';
                document.getElementById('timeError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('timeGroup').classList.remove('error');
                document.getElementById('timeError').style.display = 'none';
            }
            if (cart.length === 0) {
                showNotification('è«‹é¸æ“‡è‡³å°‘ä¸€æ¨£é¤é»', 'error', 3000);
                isValid = false;
            }
            return isValid;
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success', duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        // è¨­å®šè¼‰å…¥ç‹€æ…‹
        function setLoading(loading) {
            const loadingElement = document.getElementById('loading');
            const submitBtn = document.getElementById('submitBtn');
            if (loading) {
                loadingElement.style.display = 'flex';
                submitBtn.style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
                submitBtn.style.display = 'block';
            }
        }

        // é¡¯ç¤ºé€šçŸ¥ç‹€æ…‹
        function showNotificationStatus(storeResult, customerResult) {
            const statusContainer = document.getElementById('notificationStatus');
            let statusHtml = '';
            if (storeResult && storeResult.success) {
                statusHtml += '<div class="notification-status success">âœ… åº—å®¶å·²æ”¶åˆ°è¨‚å–®é€šçŸ¥</div>';
            } else {
                statusHtml += `<div class="notification-status error">âš ï¸ åº—å®¶é€šçŸ¥: ${storeResult?.message || 'ç™¼é€å¤±æ•—'}</div>`;
            }
            if (customerResult && customerResult.success) {
                statusHtml += '<div class="notification-status success">âœ… å·²ç™¼é€ LINE é€šçŸ¥çµ¦æ‚¨</div>';
            } else if (isLineMode) {
                statusHtml += `<div class="notification-status error">âš ï¸ å®¢æˆ¶é€šçŸ¥: ${customerResult?.message || 'æœªç™¼é€'}</div>`;
            }
            statusContainer.innerHTML = statusHtml;
        }

        // æäº¤è¨‚å–®
        async function submitOrder() {
            if (!validateForm()) return;
            const customerName = document.getElementById('customerName').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            const pickupTime = document.getElementById('pickupTime').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
            const notes = document.getElementById('notes').value.trim();
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryFee = deliveryAddress ? 30 : 0;
            const finalTotal = totalAmount + deliveryFee;
            const orderData = {
                customerName,
                customerPhone,
                customerLineUserId: isLineMode ? (userProfile?.userId || 'LINE_USER') : 'WEB_USER',
                items: cart,
                totalAmount: finalTotal,
                pickupTime,
                deliveryAddress,
                notes,
                timestamp: new Date().toISOString(),
                source: isLineMode ? 'LINE' : (isBasicMode ? 'BASIC' : 'WEB')
            };
            setLoading(true);
            try {
                const result = await submitOrderViaGet(orderData);
                if (result.success) {
                    const orderId = result.data?.orderId || 'N/A';
                    if (result.data.notifications) {
                        showNotificationStatus(result.data.notifications.store, result.data.notifications.customer);
                    }
                    let successMessage = `âœ… è¨‚å–®æˆåŠŸï¼\nè¨‚å–®ç·¨è™Ÿ: ${orderId}\nç¸½é‡‘é¡: $${finalTotal}`;
                    if (isLineMode) {
                        successMessage += '\nğŸ“± å·²ç™¼é€è¨‚å–®ç¢ºèªé€šçŸ¥';
                    } else {
                        successMessage += '\nğŸ“ åº—å®¶å°‡é›»è©±ç¢ºèªè¨‚å–®';
                    }
                    showNotification(successMessage, 'success', 6000);
                    resetOrder();
                } else {
                    throw new Error(result.message || 'è¨‚å–®è™•ç†å¤±æ•—');
                }
            } catch (error) {
                let errorMessage = `âŒ ç™¼é€å¤±æ•—\n${error.message}`;
                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                    errorMessage += '\n\nè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š';
                }
                showNotification(errorMessage, 'error', 8000);
            } finally {
                setLoading(false);
            }
        }

        // è¨­å®šé è¨­å–é¤æ™‚é–“
        function setDefaultPickupTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('pickupTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            const minDate = new Date();
            minDate.setMinutes(minDate.getMinutes() - 10);
            document.getElementById('pickupTime').min = minDate.toISOString().slice(0, 16);
        }

        // é‡ç½®è¨‚å–®
        function resetOrder() {
            cart = [];
            renderCart();
            document.getElementById('customerPhone').value = '';
            document.getElementById('deliveryAddress').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('phoneGroup').classList.remove('error');
            document.getElementById('timeGroup').classList.remove('error');
            document.getElementById('phoneError').style.display = 'none';
            document.getElementById('timeError').style.display = 'none';
            document.getElementById('notificationStatus').innerHTML = '';
            setDefaultPickupTime();
            updateOrderSummary();
            if (!userProfile) {
                document.getElementById('customerName').value = '';
            }
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½
        function initializeEventListeners() {
            document.getElementById('deliveryAddress').addEventListener('input', updateOrderSummary);
            document.getElementById('menuSelect').addEventListener('change', addToCart);
            document.getElementById('customerPhone').addEventListener('input', function() {
                const phone = this.value.trim();
                const phoneRegex = /^09\d{8}$/;
                if (phone && !phoneRegex.test(phone)) {
                    document.getElementById('phoneGroup').classList.add('error');
                    document.getElementById('phoneError').style.display = 'block';
                } else {
                    document.getElementById('phoneGroup').classList.remove('error');
                    document.getElementById('phoneError').style.display = 'none';
                }
            });
            document.getElementById('pickupTime').addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('timeGroup').classList.remove('error');
                    document.getElementById('timeError').style.display = 'none';
                    if (new Date(this.value) < new Date()) {
                        document.getElementById('timeGroup').classList.add('error');
                        document.getElementById('timeError').textContent = 'å–é¤æ™‚é–“ä¸èƒ½æ˜¯éå»æ™‚é–“';
                        document.getElementById('timeError').style.display = 'block';
                    }
                }
            });
            setInterval(() => {
                document.getElementById('submitBtn').disabled = cart.length === 0;
            }, 1000);
        }

        // é é¢è¼‰å…¥åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            setDefaultPickupTime();
            initializeLiff();
        });
    </script>
</body>
</html>
